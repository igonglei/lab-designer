!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.labDesigner=t(e.jQuery)}(this,function(C){var m="undefined"!=typeof window?window.document:{},a={lab:null,width:1280,height:850,root:"static/plugins/labDesigner/",imageDir:"images/",dataDir:"data/",layout:"lab-layout.png",data:null,url:"lab.json",bakFile:"lab.bak.json",editorMode:!0,tooltip:null,contextMenu:null,handleImage:"dot.png",handleSize:16,rotateImage:"rotate.png",rotateSize:18,checkOverlayImage:"success.png",checkOverlaySize:16,rateOverlayImage:[{src:"low.png",hsrc:"low-h.png",min:0,max:30},{src:"middle.png",hsrc:"middle-h.png",min:30,max:60},{src:"high.png",hsrc:"high-h.png",min:60}],rateOverlaySize:6,moveStepSize:2,resizeStepSize:2,lang:"cn",editorUrl:"designer?lab={lab}",saveAction:"designer/save",labListAction:"",cabListAction:"designer/GetCabinetNumInfo",cabInfoAction:"",fakeCabInfo:{deviceList:[{SmallType:"OptiXOSN1800V",IP:"129.8.10.87",CabinetPosition:"A1-1",TotalRate:20},{SmallType:"OptiXOSN1800U",IP:"129.8.9.1",CabinetPosition:"A1-2",TotalRate:70}],uNum:[{no:"A1",usedU:11,allU:80}]},cabUCountAction:"",fakeCabUCount:[{no:"A1",usedU:11,allU:80},{no:"A2",usedU:19,allU:80},{no:"A3",usedU:22,allU:80},{no:"A4",usedU:28,allU:80},{no:"A5",usedU:0,allU:80},{no:"A6",usedU:0,allU:80},{no:"A7",usedU:36,allU:80},{no:"A8",usedU:36,allU:80},{no:"A9",usedU:34,allU:80},{no:"A10",usedU:69,allU:80},{no:"A11",usedU:69,allU:80},{no:"A12",usedU:45,allU:80},{no:"A13",usedU:69,allU:80},{no:"A14",usedU:51,allU:80}],updateLabAction:"designer/UpdateUsedCabinet",updateSpeCabAction:"designer/UpdateSpecialCabinetInfo",exportAction:"",pdu:"WuhanRC"},r="0x0000",o={browserNotSupported:{cn:"浏览器不支持！",en:"Browser is not supported!"},cab:{cn:"机柜",en:"Cabinet"},powerCab:{cn:"配电柜",en:"DB"},toggleCab:{cn:"开关柜",en:"SC"},netCab:{cn:"网络柜",en:"NC"},lineCab:{cn:"配线柜",en:"WC"},devCab:{cn:"仪表柜",en:"DEV"},iondCab:{cn:"IOND柜",en:"IOND"},serverCab:{cn:"服务器柜",en:"Server"},airCon:{cn:"空调",en:"AC"},wall:{cn:"承重墙",en:"Wall"},zoomIn:{cn:"放大",en:"ZoomIn"},zoomOut:{cn:"缩小",en:"ZoomOut"},actualSize:{cn:"实际大小",en:"Actual size"},fullsize:{cn:"全屏",en:"Fullsize"},move:{cn:"移动",en:"Move"},download:{cn:"下载",en:"Download"},capacity:{cn:"容量",en:"Capacity"},del:{cn:"删除",en:"Delete"},undo:{cn:"撤销",en:"Undo"},redo:{cn:"重做",en:"Redo"},save:{cn:"保存",en:"Save"},show:{cn:"显示",en:"Show"},hide:{cn:"隐藏",en:"Hide"},clear:{cn:"清空",en:"Clear"},copy:{cn:"复制",en:"Copy"},paste:{cn:"粘贴",en:"Paste"},edit:{cn:"编辑",en:"Edit"},selectAll:{cn:"全选",en:"Select All"},saveSuccess:{cn:"保存成功",en:"Save successful"},restore:{cn:"还原到上一个版本",en:"Revert to the previous version"},noChange:{cn:"没有改动",en:"No change"},labList:{cn:"实验室列表",en:"Lab list"},cabList:{cn:"机柜列表",en:"Cabinet list"},unsavedChanges:{cn:"存在未保存的改动，确定切换实验室？",en:"There are unsaved changes, be sure to change lab?"},ok:{cn:"确定",en:"OK"},cancel:{cn:"取消",en:"Cancel"},associated:{cn:"此机柜已关联",en:"The cabinet has been associated"},loading:{cn:"载入中...",en:"Loading..."},loadSuccess:{cn:"载入成功",en:"Load successfully"},print:{cn:"打印",en:"Print"}},c=[{name:"cab-down",image:"cab-down.png",type:"cab",width:24,lengend:!0},{name:"cab-down-low",image:"cab-down-low.png",type:"cab",width:24},{name:"cab-down-middle",image:"cab-down-middle.png",type:"cab",width:24},{name:"cab-down-high",image:"cab-down-high.png",type:"cab",width:24},{name:"cab-dev",image:"cab-dev.png",type:"devCab",width:24,lengend:!0},{name:"cab-iond",image:"cab-iond.png",type:"iondCab",width:24,lengend:!0},{name:"cab-server",image:"cab-server.png",type:"serverCab",width:24,lengend:!0},{name:"power-down",image:"power-down.png",type:"powerCab",width:24,lengend:!0},{name:"toggle-down",image:"toggle-down.png",type:"toggleCab",width:24,lengend:!0},{name:"net-down",image:"net-down.png",type:"netCab",width:24,lengend:!0},{name:"line-down",image:"line-down.png",type:"lineCab",width:24,lengend:!0},{name:"air-left",image:"air-left.png",type:"airCon",width:32,lengend:!0},{name:"air-mini",image:"air-mini.png",type:"airCon",width:32},{name:"wall",image:"wall.png",type:"wall",width:44}],s="lde-body",l="labDesigner",t="lde-toolbar",d="lde-designer",e="lde-lengend",u="lde-tooltip",i="lde-tools",p="lde-tip",n="lde-editor-toolbar",h="lde-editor-toolbox",g="lde-editor-propbox",f="separator",v="selected",b="lde-editor-box",y="lde-editor-toolbox-title",x="lde-editor-toolbox-item",w="lde-editor-messagebar",S="lde-editor-propbox-lab",k="lde-editor-propbox-lab-list",T="lde-editor-propbox-cab",U="lde-editor-propbox-cab-list",I="lde-editor-propbox-cab-title",M="lde-editor-propbox-cab-item",E="lde-designer-modal",L="lde-designer-modal-mask",N="lde-designer-modal-body",A="lde-printer",O='<div class="{cls}" data-name="{target}"><div class="title"><span>{name}</span><a href="javascript:void(0)">查看详情</a></div><div class="rate"><span>U位利用率：{rate}%</span><span class="u">U位：<div class="bar"><div class="success" style="width:{rate}%"></div></div>{use_u}/{total_u}</span></div><table class="devices"><thead><tr><th>设备({device_count})</th><th>IP</th><th>设备利用率</th><th>位置</th></tr></thead><tbody>{device_html}</tbody></table></div>',D='<tr><td><a class="name" href="javascript:void(0)">{SmallType}</a></td><td>{IP}</td><td>{Rate}</td><td>{CabinetPosition}</td></tr>',P='<li><div class="icon {type}"></div><div>{text}</div></li>',z='<li class="{type}" title="{text}"></li>',H='<li><span class="icon {cls}"></span><span>{text}</span></li>',_='<li class="icon {type}" title="{text}"></li>',G='<li class="{type}"></li>',V='<div class="toggle-icon {cls}" title="{text}"></div>',R='<li class="{selectedCls}" data-name="{text}"><div class="{cls}"><span class="text">{text}</span><span class="icon"></span></div></li>',F='<li><img src="{src}" alt="{name}" data-type="{name}" style="width:{width}px;" /></li>',j='<span class="shortcut">{key}</span>',X='<span class="icon {level}"></span><span class="text">{text}</span>',J='<div class="lde-editor-propbox-title">{title}</div>',B='<li data-val="{_id}" data-name="{name}" class="{cls}" title="{name}"><div class="icon"></div><div class="title">{name}</div><div class="checked-icon"></div></li>',Y={tools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"download",onclick:function(){this.exportImage()}},{type:"print",onclick:function(){this.print()}}],tip:[{cls:"low",text:"0-30"},{cls:"middle",text:"30-60"},{cls:"high",text:"60-100"}],etools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"separator"},{type:"undo",onclick:function(){this.undo()},key:"Ctrl+Z"},{type:"redo",onclick:function(){this.redo()},key:"Ctrl+Y"},{type:"separator"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"},{type:"del",onclick:function(){this.remove()},key:"Delete"},{type:"clear",onclick:function(){this.clear()},key:"Ctrl+Delete"},{type:"separator"},{type:"restore",onclick:function(){this.restore()}},{type:"save",onclick:function(){this.save()},key:"Ctrl+S"}],emenus4cell:[{type:"copy",onclick:function(){this.copy()},key:"Ctrl+C"},{type:"del",onclick:function(){this.remove()},key:"Delete"}],emenus:[{type:"paste",onclick:function(){this.pasteHere()},key:"Ctrl+V"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"}],shortcuts:[{keyCode:46,key:"Delete",action:function(){this.remove()}},{keyCode:46,key:"Ctrl+Delete",isCtrl:!0,action:function(){this.clear()}},{keyCode:65,key:"Ctrl+A",isCtrl:!0,action:function(){this.selectAll()}},{keyCode:90,key:"Ctrl+Z",isCtrl:!0,action:function(){this.undo()}},{keyCode:89,key:"Ctrl+Y",isCtrl:!0,action:function(){this.redo()}},{keyCode:67,key:"Ctrl+C",isCtrl:!0,action:function(){this.copy()}},{keyCode:86,key:"Ctrl+V",isCtrl:!0,action:function(){this.paste()}},{keyCode:83,key:"Ctrl+S",isCtrl:!0,action:function(){this.save()}}]},K=function(a,o){if(!a||!o)return a;var s=/{(.*?)}/g,e=a.match(s);return C.each(e,function(e,t){var n=t.replace(s,"$1"),i=o[n];void 0!==i&&(a=a.replace(t,i))}),a},W=function(e){return C.map(e,function(e){return JSON.parse(e)})},q={name:"labDesigner",init:function(e){mxClient.isBrowserSupported()?(this.overridePrototype(),this.newGraph(e),this.setBackground(e),this.setContextMenu(e),this.setTooltip(e),this.setHighlight(e),this.putStyle(e),this.loadData(e)):mxUtils.error(this.getText(e,"browserNotSupported"),250,!1)},newGraph:function(e){var t=e.editor=new mxEditor,n=e.graph=t.graph,i=C(e.dom).empty(),a=C('<div class="'+d+'"></div>').appendTo(i);n.init(a[0]),C(m.body).addClass(s),i.addClass(l),n.labelsVisible=!1,n.cellsEditable=!1,n.cellsLocked=!0,this.initFilePath(e),this.initEditor(e)},initEditor:function(e){var t=e.graph;e.options.editorMode?(t.cellsLocked=!1,t.graphHandler.guidesEnabled=!0,new mxRubberband(t),this.setShortcuts(e),this.setEditorToolbar(e),this.setEditorToolbox(e),this.setEditorPropbox(e),this.setMessagebar(e),this.bindEvent(e),this.setHandleImage(e),this.rotateCells(e)):(this.setToolbar(e),this.setLengend(e))},setBackground:function(e,t){var n=e.options,i=e.graph,a=e.path.background,o=n.width,s=n.height;if(i.backgroundImage=new mxImage(a,o,s),i.view.validate(),!t){C(i.container).css({width:o,height:s});var l=new mxRectangle(0,0,o,s);i.maximumGraphBounds=l,i.minimumContainerSize=l}},bindEvent:function(i){var e=i.graph;e.getModel().addListener(mxEvent.CHANGE,mxUtils.bind(this,function(e,t){i.changed=!0})),e.addListener(mxEvent.CLICK,mxUtils.bind(this,function(e,t){var n=t.getProperty("cell");this.isCabCell(n)?this.initCabPropbox(i,n):this.initLabPropbox(i)}))},isCabCell:function(e,t){var n=e&&/^cab/i.test(e.style);return!0===t&&(n=n&&e.value),n},initFilePath:function(e){var t=e.options,n=K("{root}{dataDir}{lab}/",t);e.path={background:n+t.layout,file:n+t.url,bakFile:n+t.bakFile,imgPath:t.root+t.imageDir}},reloadEditor:function(e){this.initFilePath(e),this.setBackground(e,!0),e.clear(),this.loadData(e)},loadData:function(t,n){var i=this,e=t.options,a=e.url,o=function(e){e&&e.vertex?(t.data=e,i.fillGraph(t),n||(t.changed=!1),i.successMsg(t,i.getText(t,"loadSuccess"))):t.changed=!1};if(a)return a=t.path[n?"bakFile":"file"],i.infoMsg(t,i.getText(t,"loading")),void C.getJSON(a+"?ts="+(new Date).valueOf(),function(e){o(e)}).fail(function(e){t.changed=!1,i.errorMsg(t,e.statusText)});o(e.data)},putStyle:function(n){n.options;C.each(c,function(e,t){n.graph.getStylesheet().putCellStyle(t.name,{shape:"image",image:n.path.imgPath+t.image})})},fillGraph:function(i,e,a){var o=i.graph,t=o.getModel(),s=o.getDefaultParent(),n=e||i.data.vertex,l=this;t.beginUpdate();try{C.each(n,function(e,t){var n=o.insertVertex(s,null,t.value,t.x,t.y,t.width,t.height,t.style);a&&o.setSelectionCell(n),i.options.editorMode&&t.value&&t.value.name&&l.setCheckCellOverlay(i,n)})}finally{t.endUpdate(),i.options.editorMode||l.getLabList(i).done(function(){l.getCabUCount(i).done(function(){l.setRateCellOverlay(i)})})}},save:function(t){if(t.changed){var e=t.graph.getChildVertices(),n=C.map(e,function(e,t){var n=e.geometry;return{width:n.width,height:n.height,x:n.x,y:n.y,style:e.style,value:e.value}}),i=this.getUsedCells(t,e).length,a=this.getSpecialCab(t,e),o=this;C.post(t.options.saveAction,{file:t.path.file,bakFile:t.path.bakFile,data:JSON.stringify({vertex:n})},function(e){e.ErrCode===r?(o.successMsg(t,o.getText(t,"saveSuccess")),t.changed=!1,o.updateLabAction(t,i),0<a.length&&o.updateSpecialCab(t,a)):o.errorMsg(t,e.ErrCode)}).fail(function(e){o.errorMsg(t,e.statusText)})}else this.infoMsg(t,this.getText(t,"noChange"),!0)},getUsedCells:function(e,t){return C.grep(t||e.graph.getChildVertices(),function(e){return e.value&&e.value.name})},getSpecialCab:function(e,t){return C.map(t||e.graph.getChildVertices(),function(e){return("cab-dev"==e.style||"cab-iond"==e.style||"cab-server"==e.style)&&e.value&&e.value.name?e.value.name:null})},restore:function(e){e.clear(),this.loadData(e,!0)},setEditorToolbar:function(r){var c=C('<ul class="'+n+'"></ul>').prependTo(C(r.dom)),d=this;C.each(Y.etools,function(e,t){var n=t.type,i=n===f?G:_,a=t.key||"",o=a&&" ("+a+")",s=C(K(i,{type:n,text:d.getText(r,n)+o})),l=t.onclick;c.append(s),"function"==typeof l&&s.click(function(){l.call(r)})})},setEditorToolbox:function(a){var e=C('<div class="'+h+'"></div>').appendTo(C(a.dom)),o=C('<ul class="'+b+'"></ul>').appendTo(e),s=this;a.options;this.setToggleIcon(a,o,"left-hide","right-show");var l={};C.each(c,function(e,t){var n=t.type,i=l[n]||[];i.push(t),l[n]=i});var r=c[0].type;C.each(l,function(e,t){var n=C(K(R,{text:s.getText(a,e),cls:y,selectedCls:e===r?v:""})).appendTo(o),i=C('<ul class="'+x+'"></ul>').appendTo(n);C.each(t,function(e,t){t.src=a.path.imgPath+t.image;var n=C(K(F,t)).appendTo(i);s.makeDraggable(n.find("img")[0],a)})}),o.on("click","."+y,function(){C(this).parent().toggleClass(v)})},setToggleIcon:function(e,t,n,i){var a=this;C(K(V,{cls:n,text:a.getText(e,"hide")})).insertAfter(t).click(function(){t.toggle(),C(this).toggleClass(i).attr("title",a.getText(e,t.is(":visible")?"hide":"show"))})},makeDraggable:function(o,s){mxClient.IS_IE&&mxEvent.addListener(o,"dragstart",function(e){e.returnValue=!1});var e=s.graph,t=o.cloneNode(!0),l=this;mxUtils.makeDraggable(o,e,function(e,t,n,i,a){l.fillGraph(s,[{x:i,y:a,width:o.width,height:o.height,style:o.getAttribute("data-type")}],!0)},t,null,null,e.autoscroll,!0).isGuidesEnabled=function(){return e.graphHandler.guidesEnabled}},setContextMenu:function(s){var i=s.options,a=i.contextMenu,l=this,r=s.graph;mxEvent.disableContextMenu(r.container),r.popupMenuHandler.factoryMethod="function"==typeof a?function(e,t,n){return a.apply(s,arguments)}:function(o,e,t){if(i.editorMode){var n=0===r.getSelectionCells().length?Y.emenus:Y.emenus4cell;C.each(n,function(e,t){var n=t.type,i=t.onclick,a=o.addItem(l.getText(s,n),null,function(){i&&i.call(s)},null,"icon "+n);t.key&&C(a).find(":last").append(K(j,t))})}}},pasteHere:function(e){var t=e.graph;t.getModel().beginUpdate();try{var n=e.paste(),i=n&&t.getBoundingBoxFromGeometry(n);if(null===i)return;var a=t.view.translate,o=t.view.scale,s=a.x,l=a.y,r=Math.round(t.snap(t.popupMenuHandler.triggerX/o-s)),c=Math.round(t.snap(t.popupMenuHandler.triggerY/o-l));t.cellsMoved(n,r-i.x,c-i.y)}finally{t.getModel().endUpdate()}},setShortcuts:function(n){var e=n.graph,i=new mxKeyHandler(e);C.each(Y.shortcuts,function(e,t){i[t.isCtrl?"bindControlKey":"bindKey"](t.keyCode,function(e){t.action.call(n)})}),n.keyHandler=i,this.setArrowEvent(n)},setArrowEvent:function(e){var r=e.graph,n=e.keyHandler,t=e.options,i=t.moveStepSize,a=t.resizeStepSize,c={LEFT:37,UP:38,RIGHT:39,DOWN:40},d=[],u=null,o=function(o,s,l){d.push(function(){if(l){r.getModel().beginUpdate();try{for(var e=r.getSelectionCells(),t=0;t<e.length;t++)if(r.getModel().isVertex(e[t])&&r.isCellResizable(e[t])){var n=r.getCellGeometry(e[t]);null!=n&&(n=n.clone(),o==c.LEFT?n.width=Math.max(0,n.width-s):o==c.UP?n.height=Math.max(0,n.height-s):o==c.RIGHT?n.width+=s:o==c.DOWN&&(n.height+=s),r.getModel().setGeometry(e[t],n))}}finally{r.getModel().endUpdate()}}else{var i=0,a=0;o==c.LEFT?i=-s:o==c.UP?a=-s:o==c.RIGHT?i=s:o==c.DOWN&&(a=s),r.moveCells(r.getMovableCells(r.getSelectionCells()),i,a)}}),null!=u&&window.clearTimeout(u),u=window.setTimeout(function(){if(0<d.length){r.getModel().beginUpdate();try{for(var e=0;e<d.length;e++)d[e]();d=[]}finally{r.getModel().endUpdate()}r.scrollCellToVisible(r.getSelectionCell())}},200)};C.each(c,function(e,t){n.bindKey(t,function(e){o(e.keyCode,i)}),n.bindControlKey(t,function(e){o(e.keyCode,a,!0)})})},setTooltip:function(l){var r=l.graph,t=l.options.tooltip,c=this;r.getTooltipForCell="function"==typeof t?function(e){return t.apply(l,arguments)}:function(e){if(c.isCabCell(e,!0)){var t=e.value,o=l.dom.id+"-"+t.name,s={cls:u,name:t.name,device_count:0,total_u:0,use_u:0,rate:0,device_html:"",target:o};return c.getCabInfo(l,t.name,e.style).done(function(e){var t=(n=l.cabInfo).deviceList,n=n.uNum[0]||{allU:0,usedU:0},i="";C.each(t,function(e,t){t.Rate="-1"===t.TotalRate?"-":(t.TotalRate||0)+"%",i+=K(D,t)}),C.extend(s,{device_count:t.length,total_u:n.allU,use_u:n.usedU,rate:0<n.allU?parseFloat((n.usedU/n.allU*100).toFixed(1)):0,device_html:i});var a=K(O,s);C("."+u).filter('[data-name="'+o+'"]').parent().html(a),c.fitTooltip(r)}),K(O,s)}}},setHandleImage:function(e){var t=e.options;mxVertexHandler.prototype.handleImage=new mxImage(e.path.imgPath+t.handleImage,t.handleSize,t.handleSize)},fitTooltip:function(e){var t=e.tooltipHandler&&e.tooltipHandler.div;t&&mxUtils.fit(t)},setHighlight:function(e){new mxCellTracker(e.graph).highlight.strokeWidth=1},setLengend:function(n){var i=C('<ul class="'+e+'"></ul>').appendTo(C(n.dom)),a=this;C.each(c,function(e,t){t.lengend&&i.append(K(P,{type:t.type,text:a.getText(n,t.type)}))})},setToolbar:function(a){var e=C('<div class="'+t+'"></div>').prependTo(C(a.dom)),o=C('<ul class="'+i+'"></ul>').appendTo(e),n=C(K('<ul class="{cls}"><li>{text}(%)</li></ul>',{cls:p,text:this.getText(a,"capacity")})).appendTo(e),s=this;C.each(Y.tools,function(e,t){var n=C(K(z,{type:t.type,text:s.getText(a,t.type)})),i=t.onclick;o.append(n),"function"==typeof i&&n.click(function(){i.call(a)})}),C.each(Y.tip,function(e,t){n.append(K(H,t))})},setEditorPropbox:function(e){var t=C('<div class="'+g+'"></div>').appendTo(C(e.dom)),n=C('<div class="'+b+'"></div>').appendTo(t);this.setToggleIcon(e,n,"right-hide","left-show"),n.append('<div class="'+S+'"></div><div class="'+T+'"></div>'),this.initLabPropbox(e)},initLabPropbox:function(t){var e=C(t.dom).find("."+S);if(e.hasClass("loaded"))e.show().next().hide();else{C(K(J,{title:this.getText(t,"labList")})).appendTo(e);var n=C('<div class="lde-editor-propbox-body"></div>').appendTo(e),i=C('<ul class="'+k+'"></ul>').appendTo(n),a=t.options,o="selected",s=this,l=function(e){e.addClass(o).siblings().removeClass(o),a.lab=e.attr("data-val"),s.reloadEditor(t),s.resetCabPropbox(t)};this.getLabList(t).done(function(){e.addClass("loaded"),C.each(t.labList,function(e,t){i.append(K(B,{_id:t._id,name:t.Name,cls:t._id===a.lab?o:""}))}),i.on("click","li",function(){var e=C(this);e.hasClass(o)||(t.changed?s.confirm(t,s.getText(t,"unsavedChanges"),function(){l(e)}):l(e))})})}},initCabPropbox:function(e,t){var n=C(e.dom).find("."+T),i=function(){n.show().prev().hide()},a=v,o=t.value&&t.value.name,s=this.getGroupName(o),l=this.getCabType(t.style);if(n.hasClass("loaded"))return i(),this.loadCabList(e,t,l,s,a),n.find("."+U+">li").removeClass(a).filter('[data-name="'+s+'"]').find("."+I).trigger("click"),void n.find("."+M+">li").removeClass(a).filter('[data-name="'+o+'"]').addClass(a);n.empty(),i(),C(K(J,{title:this.getText(e,"cabList")})).appendTo(n);var r=C('<div class="lde-editor-propbox-body"></div>').appendTo(n),c=(C('<ul class="'+U+'"></ul>').appendTo(r),e.options,this);this.getCabList(e).done(function(){n.addClass("loaded"),c.loadCabList(e,t,l,s,a)})},loadCabList:function(n,e,t,a,o){var i=this;C("."+T+" .lde-editor-propbox-body").empty();var s=C(n.dom).find("."+T),l=C('<div class="lde-editor-propbox-body"></div>').appendTo(s),r=e.value&&e.value.name,c=C('<ul class="'+U+'"></ul>').appendTo(l);if(i.groupCabs(n,t),C.isEmptyObject(n.groupCabs)){C(".lde-editor-propbox-cab-list").append('<li style="padding:5px;color:#fff;">暂无该类型可绑定的机柜！</li>')}else C.each(n.groupCabs,function(e,t){var n=C(K(R,{text:e,cls:I,selectedCls:a===e?o:""})).appendTo(c),i=C('<ul class="'+M+'"></ul>').appendTo(n);C.each(t,function(e,t){i.append(K(B,{_id:t._id||"",name:t.CabinetNum,cls:t.CabinetNum===r?o:""}))})});c.on("click","."+I,function(){C(this).parent().toggleClass(o).siblings().removeClass(o)}),c.on("click","."+M+">li",function(){var e=n.graph.getSelectionCell(),t=C(this);t.hasClass(o)||(t.addClass(o).siblings().removeClass(o),e.value={name:t.attr("data-name")},i.setCheckCellOverlay(n,e),n.changed=!0)})},groupCabs:function(e,n){var t=e.cabList,i={},a=this,o=C.map(t,function(e,t){return e.CabinetType&&e.CabinetType==n?e:null});e.groupCabs=i,0<o.length&&(C.each(o,function(e,t){var n=a.getGroupName(t.CabinetNum);i[n]?i[n].push(t):i[n]=[t]}),C.each(i,function(e,t){t=t.sort(function(e,t){return parseInt(e.CabinetNum.slice(1))-parseInt(t.CabinetNum.slice(1))})}),e.groupCabs=i)},getGroupName:function(e){return e&&e.slice(0,1).toUpperCase()},resetCabPropbox:function(e){C(e.dom).find("."+T).removeClass("loaded")},setCheckCellOverlay:function(i,e){var a=i.graph,t=i.options,n=t.checkOverlaySize,o=new mxImage(i.path.imgPath+t.checkOverlayImage,n,n),s=new mxCellOverlay(o,null,"center","middle",null,"default");a.addCellOverlay(e,s),s.addListener(mxEvent.CLICK,mxUtils.bind(this,function(e,t){var n=t.getProperty("cell");a.setSelectionCell(n),this.initCabPropbox(i,n)}))},setRateCellOverlay:function(e,t,n){var g=e.graph,m=e.path.imgPath,i=e.options,f=i.rateOverlaySize,v=i.rateOverlayImage,b=c[0].width,a=function(e,t){var n=0===t?v[0]:C.grep(v,function(e){return t>e.min&&t<=(e.max||Number.MAX_VALUE)})[0];if(n){var i,a,o,s,l,r,c,d,u=mxUtils.getValue(g.view.getState(e).style,mxConstants.STYLE_DIRECTION,"east"),p=e.geometry.width,h=e.geometry.height;"east"===u||"west"===u?(l="src",r=(o=f*(d=p/b))/2,c=(s=h-8*d)/2,"west"===u&&(c+=8*d)):(l="hsrc",r=(o=p-8*(d=h/b))/2,c=(s=f*d)/2,"south"===u&&(r+=8*d)),i=new mxImage(m+n[l],o,s),a=new mxCellOverlay(i,null,"left","top",new mxPoint(r,c),"default"),g.addCellOverlay(e,a)}};if(t&&n)a(t,n);else{var o=this.getUsedCells(e),s=e.cabUCountList||[];C.each(o,function(e,t){var n=C.grep(s,function(e){return e.no===t.value.name})[0];if(n){var i=0<n.allU?n.usedU/n.allU*100:0;a(t,i)}})}},getText:function(e,t){var n=o[t],i=e.options.lang;return n&&(n[i]||n[a.lang])},setMessagebar:function(e){var t=C(e.dom).find("."+n);C(K('<li class="{cls}"></li>',{cls:w})).appendTo(t)},showMessage:function(e,t,n,i){var a=C(e.dom).find("."+w);a.html(K(X,{level:n||"",text:t||""})),a.show(),i&&window.setTimeout(function(){a.fadeOut()},3e3)},infoMsg:function(e,t,n){this.showMessage(e,t,"info",n)},successMsg:function(e,t){this.showMessage(e,t,"success",!0)},warnMsg:function(e,t){this.showMessage(e,t,"warn")},errorMsg:function(e,t){this.showMessage(e,t,"error")},getLabList:function(t){var e=t.options,n=this,i=e.labListAction;return i?C.get(i,{strQuery:JSON.stringify({PDUGID:e.pdu}),strField:JSON.stringify({Name:1})},function(e){e.ErrCode===r?t.labList=W(e.Documents):n.errorMsg(t,e.ErrCode)}).fail(function(e){n.errorMsg(t,e.statusText)}):C.ajax().done(function(){t.labList=[]})},getCabList:function(t){var e=t.options,n=this;return n.infoMsg(t,n.getText(t,"loading")),C.get(e.cabListAction,{sParams:JSON.stringify({PDU:e.pdu,LabGID:e.lab})},function(e){e.ErrCode===r?(n.successMsg(t,n.getText(t,"loadSuccess")),t.cabList=C.map(e.Jsons,function(e,t){var n=JSON.parse(e);return{CabinetNum:n.CabinetNum,CabinetType:n.CabinetType}})):n.errorMsg(t,e.ErrCode)}).fail(function(e){n.errorMsg(t,e.statusText)})},getCabInfo:function(t,e,n){var i=t.options,a=i.lab,o=this,s=i.cabInfoAction,l="cab-dev"===n||"cab-iond"===n||"cab-server"===n;return s?C.get(s,{strCabParams:JSON.stringify({LabGID:a,CabinetNum:e}),strDevParams:JSON.stringify({PhysicLabId:a,CabinetNum:e}),IsSepecialCab:l},function(e){e.ErrCode===r?t.cabInfo={deviceList:W(e.DeviceList.Documents),uNum:W(e.UNum.Documents)}:o.errorMsg(t,e.ErrCode)}).fail(function(e){o.errorMsg(t,e.statusText)}):C.ajax().done(function(e){t.cabInfo=i.fakeCabInfo})},getCabType:function(e){var t="";switch(e){case"cab-down":case"cab-down-low":case"cab-down-middle":case"cab-down-high":t="cab";break;case"cab-dev":t="devCab";break;case"cab-iond":t="iondCab";break;case"cab-server":t="serverCab";break;case"power-down":t="powerCab";break;case"toggle-down":t="toggleCab";break;case"net-down":t="netCab";break;case"line-down":t="lineCab"}return t},getCabUCount:function(t){var e=t.options,n=this,i=e.cabUCountAction;return i?C.get(i,{strParams:JSON.stringify({LabGID:e.lab})},function(e){e.ErrCode===r?t.cabUCountList=W(e.Documents):n.errorMsg(t,e.ErrCode)}).fail(function(e){n.errorMsg(t,e.statusText)}):C.ajax().done(function(){t.cabUCountList=e.fakeCabUCount})},updateLabAction:function(t,e){var n=t.options,i=this;return C.post(n.updateLabAction,{strParams:JSON.stringify({LabGID:n.lab,UsedCabinetNum:e})}).fail(function(e){i.errorMsg(t,e.statusText)})},updateSpecialCab:function(t,e){var n=t.options,i=this;return C.post(n.updateSpeCabAction,{strParams:JSON.stringify({LabGID:n.lab,CabinetNum:e})}).fail(function(e){i.errorMsg(t,e.statusText)})},modal:function(e,t){var n=C('<div class="'+L+'" id="'+e.dom.id+'-lde-mask"></div>').appendTo(C(m.body)),i=C('<div class="'+E+'"><div class="'+N+'"></div></div>').appendTo(n),a=C('<div class="lde-designer-modal-close">×</div>').appendTo(i);t&&t.call(n),a.click(function(){n.remove()})},confirm:function(n,i,a){var o=this;this.modal(n,function(){var e=this,t=e.find("."+N);t.append('<div class="lde-designer-modal-messager">'+i+"</div>"),t.append(K('<div class="lde-designer-modal-buttons"><button class="cancel" type="button">{cancel}</button><button class="ok" type="button">{ok}</button></div>',{ok:o.getText(n,"ok"),cancel:o.getText(n,"cancel")})),t.on("click","button",function(){e.remove(),C(this).hasClass("ok")&&a&&a.call(this)})})},exportImage:function(e){var t=e.graph,n=e.options,i=n.lab,a=n.exportAction;if(a){var o=new mxImageExport,s=t.view.scale;o.includeOverlays=!0;var l=mxUtils.createXmlDocument(),r=null!=l.createElementNS?l.createElementNS(mxConstants.NS_SVG,"svg"):l.createElement("svg");null==l.createElementNS?r.setAttribute("xmlns",mxConstants.NS_SVG):r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",mxConstants.NS_XLINK),r.style.background=C(e.dom).css("background"),r.setAttribute("width",Math.ceil(1*n.width/s)+2+"px"),r.setAttribute("height",Math.ceil(1*n.height/s)+2+"px"),r.setAttribute("version","1.1");var c=null!=l.createElementNS?l.createElementNS(mxConstants.NS_SVG,"g"):l.createElement("g");c.setAttribute("transform","translate(0.5,0.5)"),r.appendChild(c);var d=new mxSvgCanvas2D(c),u=t.getBackgroundImage();d.image(0,0,u.width,u.height,u.src);var p=null!=l.createElementNS?l.createElementNS(mxConstants.NS_SVG,"g"):l.createElement("g");p.setAttribute("transform","translate(0.5,0.5)"),r.appendChild(p),l.appendChild(r);var h=new mxSvgCanvas2D(p);h.scale(1/s),o.drawState(t.getView().getState(t.model.root),h);var g=encodeURIComponent(mxUtils.getXml(r));new mxXmlRequest(a,"filename="+i+".svg&format=svg&xml="+g).simulate(m,"_blank")}},show:function(e){var t=e.graph,n=e.options,i=t.getGraphBounds(),a=window.open(),o=a.document;mxUtils.show(t,o,i.x,i.y,n.width,n.height);var s=o.body;return o.title=n.lab,s.className=q.name,s.children[0].className=A,a},print:function(e){var t=this.show(e),n=function(){t.focus(),t.print(),t.close()};mxClient.IS_GC?t.setTimeout(n,500):n()},rotateCells:function(a){mxVertexHandler.prototype.rotationEnabled=!0,mxVertexHandler.prototype.rotateClick=function(){this.state.view.graph.turnShapes([this.state.cell])},mxGraph.prototype.turnShapes=function(e){var t=this.getModel(),n=[];t.beginUpdate();try{for(var i=0;i<e.length;i++){var a=e[i];if(t.isVertex(a)){var o=this.getCellGeometry(a);if(null!=o){(o=o.clone()).x+=o.width/2-o.height/2,o.y+=o.height/2-o.width/2;var s=o.width;o.width=o.height,o.height=s,t.setGeometry(a,o);var l=this.view.getState(a);if(null!=l){var r=l.style[mxConstants.STYLE_DIRECTION]||"east";"east"==r?r="south":"south"==r?r="west":"west"==r?r="north":"north"==r&&(r="east"),this.setCellStyles(mxConstants.STYLE_DIRECTION,r,[a])}n.push(a)}}}}finally{t.endUpdate()}return n};var o=a.options,s=mxVertexHandler.prototype.createSizerShape;mxVertexHandler.prototype.createSizerShape=function(e,t,n){var i=new mxImage(a.path.imgPath+o.rotateImage,o.rotateSize,o.rotateSize);return this.handleImage=t==mxEvent.ROTATION_HANDLE?i:this.handleImage,s.apply(this,arguments)}},overridePrototype:function(){mxGraph.prototype.init=function(e){this.container=e,this.cellEditor=this.createCellEditor(),this.view.init(),this.sizeDidChange(),mxClient.IS_IE&&(mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()})),mxEvent.addListener(e,"selectstart",mxUtils.bind(this,function(e){return this.isEditing()||!this.isMouseDown&&!mxEvent.isShiftDown(e)}))),8==m.documentMode&&e.insertAdjacentHTML("beforeend","<"+mxClient.VML_PREFIX+':group style="DISPLAY: none;"></'+mxClient.VML_PREFIX+":group>")},mxTooltipHandler.prototype.init=function(){null!=m.body&&(this.div=m.createElement("div"),this.div.className="mxTooltip",this.div.style.visibility="hidden",m.body.appendChild(this.div))},mxTooltipHandler.prototype.mouseMove=function(e,t){t.getX()==this.lastX&&t.getY()==this.lastY||(this.reset(t,!0),(this.isHideOnHover()||t.getState()!=this.state)&&this.hideTooltip()),this.lastX=t.getX(),this.lastY=t.getY()},mxTooltipHandler.prototype.show=function(e,t,n){if(!this.destroyed&&null!=e&&0<e.length){null==this.div&&this.init();var i=mxUtils.getScrollOrigin();this.div.style.zIndex=this.zIndex,this.div.style.left=t+i.x+"px",this.div.style.top=Math.min(n,580)+mxConstants.TOOLTIP_VERTICAL_OFFSET+i.y+"px",mxUtils.isNode(e)?(this.div.innerHTML="",this.div.appendChild(e)):this.div.innerHTML=e.replace(/\n/g,"<br>"),this.div.style.visibility="",mxUtils.fit(this.div)}}}},Z=function(e,t){this.dom=e,this.options=C.extend(!0,{},a,t),this.init()};return Z.prototype={constructor:Z,init:function(){q.init(this)},zoomIn:function(){this.graph.zoomIn()},zoomOut:function(){this.graph.zoomOut()},actualSize:function(){this.graph.zoomActual()},remove:function(){this.graph.removeCells()},clear:function(){this.graph.getModel().clear()},goToEditor:function(){var e=this.options;window.open(K(e.editorUrl,e))},undo:function(){this.editor.undoManager.undo()},redo:function(){this.editor.undoManager.redo()},selectAll:function(){this.graph.selectAll()},copy:function(){mxClipboard.copy(this.graph)},paste:function(){return mxClipboard.paste(this.graph)},pasteHere:function(){q.pasteHere(this)},save:function(){q.save(this)},restore:function(){q.restore(this)},show:function(){q.show(this)},print:function(){q.print(this)},exportImage:function(){q.exportImage(this)}},C.fn.labDesigner=function(t,e){return"string"==typeof t?C.fn.labDesigner.methods[t](this[0],e):this.each(function(){var e=new Z(this,t);return C.data(this,q.name,e),e})},C.fn.labDesigner.methods={instance:function(e){return C.data(e,q.name)},options:function(e){return this.instance(e).options},graph:function(e){return this.instance(e).graph}},C.fn.labDesigner.defaults=a,Z});