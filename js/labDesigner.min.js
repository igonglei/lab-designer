!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.labDesigner=t(e.jQuery)}(this,function(e){var t="undefined"!=typeof window?window.document:{},n={lab:null,width:1280,height:850,root:"static/plugins/labDesigner/",imageDir:"images/",dataDir:"data/",layout:"lab-layout.png",data:null,url:"lab.json",bakFile:"lab.bak.json",editorMode:!0,tooltip:null,contextMenu:null,handleImage:"dot.png",handleSize:16,rotateImage:"rotate.png",rotateSize:18,checkOverlayImage:"success.png",checkOverlaySize:16,rateOverlayImage:[{src:"low.png",hsrc:"low-h.png",min:0,max:30},{src:"middle.png",hsrc:"middle-h.png",min:30,max:60},{src:"high.png",hsrc:"high-h.png",min:60}],rateOverlaySize:6,moveStepSize:2,resizeStepSize:2,lang:"cn",editorUrl:"designer?lab={lab}",saveAction:"designer/save",labListAction:"",cabListAction:"designer/GetCabinetNumInfo",cabInfoAction:"",fakeCabInfo:{deviceList:[{SmallType:"OptiXOSN1800V",IP:"129.8.10.87",CabinetPosition:"A1-1",TotalRate:20},{SmallType:"OptiXOSN1800U",IP:"129.8.9.1",CabinetPosition:"A1-2",TotalRate:70}],uNum:[{no:"A1",usedU:11,allU:80}]},cabUCountAction:"",fakeCabUCount:[{no:"A1",usedU:11,allU:80},{no:"A2",usedU:19,allU:80},{no:"A3",usedU:22,allU:80},{no:"A4",usedU:28,allU:80},{no:"A5",usedU:0,allU:80},{no:"A6",usedU:0,allU:80},{no:"A7",usedU:36,allU:80},{no:"A8",usedU:36,allU:80},{no:"A9",usedU:34,allU:80},{no:"A10",usedU:69,allU:80},{no:"A11",usedU:69,allU:80},{no:"A12",usedU:45,allU:80},{no:"A13",usedU:69,allU:80},{no:"A14",usedU:51,allU:80}],updateLabAction:"designer/UpdateUsedCabinet",updateSpeCabAction:"designer/UpdateSpecialCabinetInfo",exportAction:"",pdu:"WuhanRC"},i={browserNotSupported:{cn:"浏览器不支持！",en:"Browser is not supported!"},cab:{cn:"机柜",en:"Cabinet"},powerCab:{cn:"配电柜",en:"DB"},toggleCab:{cn:"开关柜",en:"SC"},netCab:{cn:"网络柜",en:"NC"},lineCab:{cn:"配线柜",en:"WC"},devCab:{cn:"仪表柜",en:"DEV"},iondCab:{cn:"IOND柜",en:"IOND"},serverCab:{cn:"服务器柜",en:"Server"},airCon:{cn:"空调",en:"AC"},wall:{cn:"承重墙",en:"Wall"},zoomIn:{cn:"放大",en:"ZoomIn"},zoomOut:{cn:"缩小",en:"ZoomOut"},actualSize:{cn:"实际大小",en:"Actual size"},fullsize:{cn:"全屏",en:"Fullsize"},move:{cn:"移动",en:"Move"},download:{cn:"下载",en:"Download"},capacity:{cn:"容量",en:"Capacity"},del:{cn:"删除",en:"Delete"},undo:{cn:"撤销",en:"Undo"},redo:{cn:"重做",en:"Redo"},save:{cn:"保存",en:"Save"},show:{cn:"显示",en:"Show"},hide:{cn:"隐藏",en:"Hide"},clear:{cn:"清空",en:"Clear"},copy:{cn:"复制",en:"Copy"},paste:{cn:"粘贴",en:"Paste"},edit:{cn:"编辑",en:"Edit"},selectAll:{cn:"全选",en:"Select All"},saveSuccess:{cn:"保存成功",en:"Save successful"},restore:{cn:"还原到上一个版本",en:"Revert to the previous version"},noChange:{cn:"没有改动",en:"No change"},labList:{cn:"实验室列表",en:"Lab list"},cabList:{cn:"机柜列表",en:"Cabinet list"},unsavedChanges:{cn:"存在未保存的改动，确定切换实验室？",en:"There are unsaved changes, be sure to change lab?"},ok:{cn:"确定",en:"OK"},cancel:{cn:"取消",en:"Cancel"},associated:{cn:"此机柜已关联",en:"The cabinet has been associated"},loading:{cn:"载入中...",en:"Loading..."},loadSuccess:{cn:"载入成功",en:"Load successfully"},print:{cn:"打印",en:"Print"}},a=[{name:"cab-down",image:"cab-down.png",type:"cab",width:24,lengend:!0},{name:"cab-down-low",image:"cab-down-low.png",type:"cab",width:24},{name:"cab-down-middle",image:"cab-down-middle.png",type:"cab",width:24},{name:"cab-down-high",image:"cab-down-high.png",type:"cab",width:24},{name:"cab-dev",image:"cab-dev.png",type:"devCab",width:24,lengend:!0},{name:"cab-iond",image:"cab-iond.png",type:"iondCab",width:24,lengend:!0},{name:"cab-server",image:"cab-server.png",type:"serverCab",width:24,lengend:!0},{name:"power-down",image:"power-down.png",type:"powerCab",width:24,lengend:!0},{name:"toggle-down",image:"toggle-down.png",type:"toggleCab",width:24,lengend:!0},{name:"net-down",image:"net-down.png",type:"netCab",width:24,lengend:!0},{name:"line-down",image:"line-down.png",type:"lineCab",width:24,lengend:!0},{name:"air-left",image:"air-left.png",type:"airCon",width:32,lengend:!0},{name:"air-mini",image:"air-mini.png",type:"airCon",width:32},{name:"wall",image:"wall.png",type:"wall",width:44}],o={container:"labDesigner",toolbar:"lde-toolbar",designer:"lde-designer",lengend:"lde-lengend",tooltip:"lde-tooltip",tools:"lde-tools",tip:"lde-tip",eToolbar:"lde-editor-toolbar",eToolbox:"lde-editor-toolbox",ePropbox:"lde-editor-propbox",separator:"separator",selectedCls:"selected",eBox:"lde-editor-box",eToolboxTitle:"lde-editor-toolbox-title",eToolboxItem:"lde-editor-toolbox-item",messagebar:"lde-editor-messagebar",ePropbox4Lab:"lde-editor-propbox-lab",ePropboxLabList:"lde-editor-propbox-lab-list",ePropbox4Cab:"lde-editor-propbox-cab",ePropboxCabList:"lde-editor-propbox-cab-list",ePropboxCabTitle:"lde-editor-propbox-cab-title",ePropboxCabItem:"lde-editor-propbox-cab-item",modal:"lde-designer-modal",modalMask:"lde-designer-modal-mask",modalBody:"lde-designer-modal-body",printer:"lde-printer"},l={tooltip:'<div class="{cls}" data-name="{target}"><div class="title"><span>{name}</span><a href="javascript:void(0)">查看详情</a></div><div class="rate"><span>U位利用率：{rate}%</span><span class="u">U位：<div class="bar"><div class="success" style="width:{rate}%"></div></div>{use_u}/{total_u}</span></div><table class="devices"><thead><tr><th>设备({device_count})</th><th>IP</th><th>设备利用率</th><th>位置</th></tr></thead><tbody>{device_html}</tbody></table></div>',tooltip_device:'<tr><td><a class="name" href="javascript:void(0)">{SmallType}</a></td><td>{IP}</td><td>{Rate}</td><td>{CabinetPosition}</td></tr>',lengend:'<li><div class="icon {type}"></div><div>{text}</div></li>',tools:'<li class="{type}" title="{text}"></li>',tip:'<li><span class="icon {cls}"></span><span>{text}</span></li>',etools:'<li class="icon {type}" title="{text}"></li>',separator:'<li class="{type}"></li>',toggle_icon:'<div class="toggle-icon {cls}" title="{text}"></div>',toolbox_group:'<li class="{selectedCls}" data-name="{text}"><div class="{cls}"><span class="text">{text}</span><span class="icon"></span></div></li>',toolbox_item:'<li><img src="{src}" alt="{name}" data-type="{name}" style="width:{width}px;" /></li>',menu_shortcut:'<span class="shortcut">{key}</span>',messagebar:'<span class="icon {level}"></span><span class="text">{text}</span>',propbox_title:'<div class="lde-editor-propbox-title">{title}</div>',propbox_list_item:'<li data-val="{_id}" data-name="{name}" class="{cls}" title="{name}"><div class="icon"></div><div class="title">{name}</div><div class="checked-icon"></div></li>'},s={tools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"download",onclick:function(){this.exportImage()}},{type:"print",onclick:function(){this.print()}}],tip:[{cls:"low",text:"0-30"},{cls:"middle",text:"30-60"},{cls:"high",text:"60-100"}],etools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"separator"},{type:"undo",onclick:function(){this.undo()},key:"Ctrl+Z"},{type:"redo",onclick:function(){this.redo()},key:"Ctrl+Y"},{type:"separator"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"},{type:"del",onclick:function(){this.remove()},key:"Delete"},{type:"clear",onclick:function(){this.clear()},key:"Ctrl+Delete"},{type:"separator"},{type:"restore",onclick:function(){this.restore()}},{type:"save",onclick:function(){this.save()},key:"Ctrl+S"}],emenus4cell:[{type:"copy",onclick:function(){this.copy()},key:"Ctrl+C"},{type:"del",onclick:function(){this.remove()},key:"Delete"}],emenus:[{type:"paste",onclick:function(){this.pasteHere()},key:"Ctrl+V"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"}],shortcuts:[{keyCode:46,key:"Delete",action:function(){this.remove()}},{keyCode:46,key:"Ctrl+Delete",isCtrl:!0,action:function(){this.clear()}},{keyCode:65,key:"Ctrl+A",isCtrl:!0,action:function(){this.selectAll()}},{keyCode:90,key:"Ctrl+Z",isCtrl:!0,action:function(){this.undo()}},{keyCode:89,key:"Ctrl+Y",isCtrl:!0,action:function(){this.redo()}},{keyCode:67,key:"Ctrl+C",isCtrl:!0,action:function(){this.copy()}},{keyCode:86,key:"Ctrl+V",isCtrl:!0,action:function(){this.paste()}},{keyCode:83,key:"Ctrl+S",isCtrl:!0,action:function(){this.save()}}]},r={tpl:function(t,n){if(!t||!n)return t;var i=/{(.*?)}/g,a=t.match(i);return e.each(a,function(e,a){var o=a.replace(i,"$1"),l=n[o];void 0!==l&&(t=t.replace(a,l))}),t},jsonMap:function(t){return e.map(t,function(e){return JSON.parse(e)})}},c={name:"labDesigner",init:function(e){mxClient.isBrowserSupported()?(this.overridePrototype(),this.newGraph(e),this.setBackground(e),this.setContextMenu(e),this.setTooltip(e),this.setHighlight(e),this.putStyle(e),this.loadData(e)):mxUtils.error(this.getText(e,"browserNotSupported"),250,!1)},newGraph:function(t){var n=t.editor=new mxEditor,i=t.graph=n.graph,a=e(t.dom).empty(),l=e('<div class="'+o.designer+'"></div>').appendTo(a);i.init(l[0]),a.addClass(o.container),i.labelsVisible=!1,i.cellsEditable=!1,i.cellsLocked=!0,this.initFilePath(t),this.initEditor(t)},initEditor:function(e){var t=e.graph;e.options.editorMode?(t.cellsLocked=!1,t.graphHandler.guidesEnabled=!0,new mxRubberband(t),this.setShortcuts(e),this.setEditorToolbar(e),this.setEditorToolbox(e),this.setEditorPropbox(e),this.setMessagebar(e),this.bindEvent(e),this.setHandleImage(e),this.rotateCells(e)):(this.setToolbar(e),this.setLengend(e))},setBackground:function(t,n){var i=t.options,a=t.graph,o=t.path.background,l=i.width,s=i.height;if(a.backgroundImage=new mxImage(o,l,s),a.view.validate(),!n){e(a.container).css({width:l,height:s});var r=new mxRectangle(0,0,l,s);a.maximumGraphBounds=r,a.minimumContainerSize=r}},bindEvent:function(e){var t=e.graph;t.getModel().addListener(mxEvent.CHANGE,mxUtils.bind(this,function(t,n){e.changed=!0})),t.addListener(mxEvent.CLICK,mxUtils.bind(this,function(t,n){var i=n.getProperty("cell");this.isCabCell(i)?this.initCabPropbox(e,i):this.initLabPropbox(e)}))},isCabCell:function(e,t){var n=e&&/^cab/i.test(e.style);return!0===t&&(n=n&&e.value),n},initFilePath:function(e){var t=e.options,n=r.tpl("{root}{dataDir}{lab}/",t);e.path={background:n+t.layout,file:n+t.url,bakFile:n+t.bakFile,imgPath:t.root+t.imageDir}},reloadEditor:function(e){this.initFilePath(e),this.setBackground(e,!0),e.clear(),this.loadData(e)},loadData:function(t,n){var i=this,a=t.options,o=a.url,l=function(e){e&&e.vertex?(t.data=e,i.fillGraph(t),n||(t.changed=!1),i.successMsg(t,i.getText(t,"loadSuccess"))):t.changed=!1};if(o)return o=t.path[n?"bakFile":"file"],i.infoMsg(t,i.getText(t,"loading")),void e.getJSON(o+"?ts="+(new Date).valueOf(),function(e){l(e)}).fail(function(e){t.changed=!1,i.errorMsg(t,e.statusText)});l(a.data)},putStyle:function(t){t.options;e.each(a,function(e,n){t.graph.getStylesheet().putCellStyle(n.name,{shape:"image",image:t.path.imgPath+n.image})})},fillGraph:function(t,n,i){var a=t.graph,o=a.getModel(),l=a.getDefaultParent(),s=n||t.data.vertex,r=this;o.beginUpdate();try{e.each(s,function(e,n){var o=a.insertVertex(l,null,n.value,n.x,n.y,n.width,n.height,n.style);i&&a.setSelectionCell(o),t.options.editorMode&&n.value&&n.value.name&&r.setCheckCellOverlay(t,o)})}finally{o.endUpdate(),t.options.editorMode||r.getLabList(t).done(function(){r.getCabUCount(t).done(function(){r.setRateCellOverlay(t)})})}},save:function(t){if(t.changed){var n=t.graph.getChildVertices(),i=e.map(n,function(e,t){var n=e.geometry;return{width:n.width,height:n.height,x:n.x,y:n.y,style:e.style,value:e.value}}),a=this.getUsedCells(t,n).length,o=this.getSpecialCab(t,n),l=this;e.post(t.options.saveAction,{file:t.path.file,bakFile:t.path.bakFile,data:JSON.stringify({vertex:i})},function(e){"0x0000"===e.ErrCode?(l.successMsg(t,l.getText(t,"saveSuccess")),t.changed=!1,l.updateLabAction(t,a),o.length>0&&l.updateSpecialCab(t,o)):l.errorMsg(t,e.ErrCode)}).fail(function(e){l.errorMsg(t,e.statusText)})}else this.infoMsg(t,this.getText(t,"noChange"),!0)},getUsedCells:function(t,n){return e.grep(n||t.graph.getChildVertices(),function(e){return e.value&&e.value.name})},getSpecialCab:function(t,n){return e.map(n||t.graph.getChildVertices(),function(e){return("cab-dev"==e.style||"cab-iond"==e.style||"cab-server"==e.style)&&e.value&&e.value.name?e.value.name:null})},restore:function(e){e.clear(),this.loadData(e,!0)},setEditorToolbar:function(t){var n=e('<ul class="'+o.eToolbar+'"></ul>').prependTo(e(t.dom)),i=this;e.each(s.etools,function(a,s){var c=s.type,d=c===o.separator?l.separator:l.etools,p=s.key||"",u=p&&" ("+p+")",h=e(r.tpl(d,{type:c,text:i.getText(t,c)+u})),g=s.onclick;n.append(h),"function"==typeof g&&h.click(function(){g.call(t)})})},setEditorToolbox:function(t){var n=e('<div class="'+o.eToolbox+'"></div>').appendTo(e(t.dom)),i=e('<ul class="'+o.eBox+'"></ul>').appendTo(n),s=this;t.options;this.setToggleIcon(t,i,"left-hide","right-show");var c={};e.each(a,function(e,t){var n=t.type,i=c[n]||[];i.push(t),c[n]=i});var d=a[0].type;e.each(c,function(n,a){var c=e(r.tpl(l.toolbox_group,{text:s.getText(t,n),cls:o.eToolboxTitle,selectedCls:n===d?o.selectedCls:""})).appendTo(i),p=e('<ul class="'+o.eToolboxItem+'"></ul>').appendTo(c);e.each(a,function(n,i){i.src=t.path.imgPath+i.image;var a=e(r.tpl(l.toolbox_item,i)).appendTo(p);s.makeDraggable(a.find("img")[0],t)})}),i.on("click","."+o.eToolboxTitle,function(){e(this).parent().toggleClass(o.selectedCls)})},setToggleIcon:function(t,n,i,a){var o=this;e(r.tpl(l.toggle_icon,{cls:i,text:o.getText(t,"hide")})).insertAfter(n).click(function(){n.toggle(),e(this).toggleClass(a).attr("title",o.getText(t,n.is(":visible")?"hide":"show"))})},makeDraggable:function(e,t){mxClient.IS_IE&&mxEvent.addListener(e,"dragstart",function(e){e.returnValue=!1});var n=t.graph,i=e.cloneNode(!0),a=this;mxUtils.makeDraggable(e,n,function(n,i,o,l,s){a.fillGraph(t,[{x:l,y:s,width:e.width,height:e.height,style:e.getAttribute("data-type")}],!0)},i,null,null,n.autoscroll,!0).isGuidesEnabled=function(){return n.graphHandler.guidesEnabled}},setContextMenu:function(t){var n=t.options,i=n.contextMenu,a=this,o=t.graph;mxEvent.disableContextMenu(o.container),o.popupMenuHandler.factoryMethod="function"==typeof i?function(e,n,a){return i.apply(t,arguments)}:function(i,c,d){if(n.editorMode){var p=0===o.getSelectionCells().length?s.emenus:s.emenus4cell;e.each(p,function(n,o){var s=o.type,c=o.onclick,d=i.addItem(a.getText(t,s),null,function(){c&&c.call(t)},null,"icon "+s);o.key&&e(d).find(":last").append(r.tpl(l.menu_shortcut,o))})}}},pasteHere:function(e){var t=e.graph;t.getModel().beginUpdate();try{var n=e.paste(),i=n&&t.getBoundingBoxFromGeometry(n);if(null===i)return;var a=t.view.translate,o=t.view.scale,l=a.x,s=a.y,r=Math.round(t.snap(t.popupMenuHandler.triggerX/o-l)),c=Math.round(t.snap(t.popupMenuHandler.triggerY/o-s));t.cellsMoved(n,r-i.x,c-i.y)}finally{t.getModel().endUpdate()}},setShortcuts:function(t){var n=t.graph,i=new mxKeyHandler(n);e.each(s.shortcuts,function(e,n){i[n.isCtrl?"bindControlKey":"bindKey"](n.keyCode,function(e){n.action.call(t)})}),t.keyHandler=i,this.setArrowEvent(t)},setArrowEvent:function(t){var n=t.graph,i=t.keyHandler,a=t.options,o=a.moveStepSize,l=a.resizeStepSize,s={LEFT:37,UP:38,RIGHT:39,DOWN:40},r=[],c=null,d=function(e,t,i){r.push(function(){if(i){n.getModel().beginUpdate();try{for(var a=n.getSelectionCells(),o=0;o<a.length;o++)if(n.getModel().isVertex(a[o])&&n.isCellResizable(a[o])){var l=n.getCellGeometry(a[o]);null!=l&&(l=l.clone(),e==s.LEFT?l.width=Math.max(0,l.width-t):e==s.UP?l.height=Math.max(0,l.height-t):e==s.RIGHT?l.width+=t:e==s.DOWN&&(l.height+=t),n.getModel().setGeometry(a[o],l))}}finally{n.getModel().endUpdate()}}else{var r=0,c=0;e==s.LEFT?r=-t:e==s.UP?c=-t:e==s.RIGHT?r=t:e==s.DOWN&&(c=t),n.moveCells(n.getMovableCells(n.getSelectionCells()),r,c)}}),null!=c&&window.clearTimeout(c),c=window.setTimeout(function(){if(r.length>0){n.getModel().beginUpdate();try{for(var e=0;e<r.length;e++)r[e]();r=[]}finally{n.getModel().endUpdate()}n.scrollCellToVisible(n.getSelectionCell())}},200)};e.each(s,function(e,t){i.bindKey(t,function(e){d(e.keyCode,o)}),i.bindControlKey(t,function(e){d(e.keyCode,l,!0)})})},setTooltip:function(t){var n=t.graph,i=t.options.tooltip,a=this;n.getTooltipForCell="function"==typeof i?function(e){return i.apply(t,arguments)}:function(i){if(a.isCabCell(i,!0)){var s=i.value,c=t.dom.id+"-"+s.name,d={cls:o.tooltip,name:s.name,device_count:0,total_u:0,use_u:0,rate:0,device_html:"",target:c};return a.getCabInfo(t,s.name,i.style).done(function(i){var s=(p=t.cabInfo).deviceList,p=p.uNum[0]||{allU:0,usedU:0},u="";e.each(s,function(e,t){t.Rate="-1"===t.TotalRate?"-":(t.TotalRate||0)+"%",u+=r.tpl(l.tooltip_device,t)}),e.extend(d,{device_count:s.length,total_u:p.allU,use_u:p.usedU,rate:p.allU>0?parseFloat((p.usedU/p.allU*100).toFixed(1)):0,device_html:u});var h=r.tpl(l.tooltip,d);e("."+o.tooltip).filter('[data-name="'+c+'"]').parent().html(h),a.fitTooltip(n)}),r.tpl(l.tooltip,d)}}},setHandleImage:function(e){var t=e.options;mxVertexHandler.prototype.handleImage=new mxImage(e.path.imgPath+t.handleImage,t.handleSize,t.handleSize)},fitTooltip:function(e){var t=e.tooltipHandler&&e.tooltipHandler.div;t&&mxUtils.fit(t)},setHighlight:function(e){new mxCellTracker(e.graph).highlight.strokeWidth=1},setLengend:function(t){var n=e('<ul class="'+o.lengend+'"></ul>').appendTo(e(t.dom)),i=this;e.each(a,function(e,a){a.lengend&&n.append(r.tpl(l.lengend,{type:a.type,text:i.getText(t,a.type)}))})},setToolbar:function(t){var n=e('<div class="'+o.toolbar+'"></div>').prependTo(e(t.dom)),i=e('<ul class="'+o.tools+'"></ul>').appendTo(n),a=e(r.tpl('<ul class="{cls}"><li>{text}(%)</li></ul>',{cls:o.tip,text:this.getText(t,"capacity")})).appendTo(n),c=this;e.each(s.tools,function(n,a){var o=e(r.tpl(l.tools,{type:a.type,text:c.getText(t,a.type)})),s=a.onclick;i.append(o),"function"==typeof s&&o.click(function(){s.call(t)})}),e.each(s.tip,function(e,t){a.append(r.tpl(l.tip,t))})},setEditorPropbox:function(t){var n=e('<div class="'+o.ePropbox+'"></div>').appendTo(e(t.dom)),i=e('<div class="'+o.eBox+'"></div>').appendTo(n);this.setToggleIcon(t,i,"right-hide","left-show"),i.append('<div class="'+o.ePropbox4Lab+'"></div><div class="'+o.ePropbox4Cab+'"></div>'),this.initLabPropbox(t)},initLabPropbox:function(t){var n=e(t.dom).find("."+o.ePropbox4Lab);if(n.hasClass("loaded"))n.show().next().hide();else{e(r.tpl(l.propbox_title,{title:this.getText(t,"labList")})).appendTo(n);var i=e('<div class="lde-editor-propbox-body"></div>').appendTo(n),a=e('<ul class="'+o.ePropboxLabList+'"></ul>').appendTo(i),s=t.options,c=this,d=function(e){e.addClass("selected").siblings().removeClass("selected"),s.lab=e.attr("data-val"),c.reloadEditor(t),c.resetCabPropbox(t)};this.getLabList(t).done(function(){n.addClass("loaded"),e.each(t.labList,function(e,t){a.append(r.tpl(l.propbox_list_item,{_id:t._id,name:t.Name,cls:t._id===s.lab?"selected":""}))}),a.on("click","li",function(){var n=e(this);n.hasClass("selected")||(t.changed?c.confirm(t,c.getText(t,"unsavedChanges"),function(){d(n)}):d(n))})})}},initCabPropbox:function(t,n){var i=e(t.dom).find("."+o.ePropbox4Cab),a=function(){i.show().prev().hide()},s=o.selectedCls,c=n.value&&n.value.name,d=this.getGroupName(c),p=this.getCabType(n.style);if(i.hasClass("loaded"))return a(),this.loadCabList(t,n,p,d,s),i.find("."+o.ePropboxCabList+">li").removeClass(s).filter('[data-name="'+d+'"]').find("."+o.ePropboxCabTitle).trigger("click"),void i.find("."+o.ePropboxCabItem+">li").removeClass(s).filter('[data-name="'+c+'"]').addClass(s);i.empty(),a(),e(r.tpl(l.propbox_title,{title:this.getText(t,"cabList")})).appendTo(i);var u=e('<div class="lde-editor-propbox-body"></div>').appendTo(i),h=(e('<ul class="'+o.ePropboxCabList+'"></ul>').appendTo(u),t.options,this);this.getCabList(t).done(function(){i.addClass("loaded"),h.loadCabList(t,n,p,d,s)})},loadCabList:function(t,n,i,a,s){var c=this;e("."+o.ePropbox4Cab+" .lde-editor-propbox-body").empty();var d=e(t.dom).find("."+o.ePropbox4Cab),p=e('<div class="lde-editor-propbox-body"></div>').appendTo(d),u=n.value&&n.value.name,h=e('<ul class="'+o.ePropboxCabList+'"></ul>').appendTo(p);if(c.groupCabs(t,i),e.isEmptyObject(t.groupCabs)){e(".lde-editor-propbox-cab-list").append('<li style="padding:5px;color:#fff;">暂无该类型可绑定的机柜！</li>')}else e.each(t.groupCabs,function(t,n){var i=e(r.tpl(l.toolbox_group,{text:t,cls:o.ePropboxCabTitle,selectedCls:a===t?s:""})).appendTo(h),c=e('<ul class="'+o.ePropboxCabItem+'"></ul>').appendTo(i);e.each(n,function(e,t){c.append(r.tpl(l.propbox_list_item,{_id:t._id||"",name:t.CabinetNum,cls:t.CabinetNum===u?s:""}))})});h.on("click","."+o.ePropboxCabTitle,function(){e(this).parent().toggleClass(s).siblings().removeClass(s)}),h.on("click","."+o.ePropboxCabItem+">li",function(){var n=t.graph.getSelectionCell(),i=e(this);i.hasClass(s)||(i.addClass(s).siblings().removeClass(s),n.value={name:i.attr("data-name")},c.setCheckCellOverlay(t,n),t.changed=!0)})},groupCabs:function(t,n){var i=t.cabList,a={},o=this,l=e.map(i,function(e,t){return e.CabinetType&&e.CabinetType==n?e:null});t.groupCabs=a,l.length>0&&(e.each(l,function(e,t){var n=o.getGroupName(t.CabinetNum);a[n]?a[n].push(t):a[n]=[t]}),e.each(a,function(e,t){t=t.sort(function(e,t){return parseInt(e.CabinetNum.slice(1))-parseInt(t.CabinetNum.slice(1))})}),t.groupCabs=a)},getGroupName:function(e){return e&&e.slice(0,1).toUpperCase()},resetCabPropbox:function(t){e(t.dom).find("."+o.ePropbox4Cab).removeClass("loaded")},setCheckCellOverlay:function(e,t){var n=e.graph,i=e.options,a=i.checkOverlaySize,o=new mxImage(e.path.imgPath+i.checkOverlayImage,a,a),l=new mxCellOverlay(o,null,"center","middle",null,"default");n.addCellOverlay(t,l),l.addListener(mxEvent.CLICK,mxUtils.bind(this,function(t,i){var a=i.getProperty("cell");n.setSelectionCell(a),this.initCabPropbox(e,a)}))},setRateCellOverlay:function(t,n,i){var o=t.graph,l=t.path.imgPath,s=t.options,r=s.rateOverlaySize,c=s.rateOverlayImage,d=a[0].width,p=function(t,n){var i=0===n?c[0]:e.grep(c,function(e){return n>e.min&&n<=(e.max||Number.MAX_VALUE)})[0];if(i){var a,s,p,u,h,g,b,m,f=mxUtils.getValue(o.view.getState(t).style,mxConstants.STYLE_DIRECTION,"east"),v=t.geometry.width,C=t.geometry.height;"east"===f||"west"===f?(h="src",g=(p=r*(m=v/d))/2,b=(u=C-8*m)/2,"west"===f&&(b+=8*m)):(h="hsrc",g=(p=v-8*(m=C/d))/2,b=(u=r*m)/2,"south"===f&&(g+=8*m)),a=new mxImage(l+i[h],p,u),s=new mxCellOverlay(a,null,"left","top",new mxPoint(g,b),"default"),o.addCellOverlay(t,s)}};if(n&&i)p(n,i);else{var u=this.getUsedCells(t),h=t.cabUCountList||[];e.each(u,function(t,n){var i=e.grep(h,function(e){return e.no===n.value.name})[0];if(i){var a=i.allU>0?i.usedU/i.allU*100:0;p(n,a)}})}},getText:function(e,t){var a=i[t],o=e.options.lang;return a&&(a[o]||a[n.lang])},setMessagebar:function(t){var n=e(t.dom).find("."+o.eToolbar);e(r.tpl('<li class="{cls}"></li>',{cls:o.messagebar})).appendTo(n)},showMessage:function(t,n,i,a){var s=e(t.dom).find("."+o.messagebar);s.html(r.tpl(l.messagebar,{level:i||"",text:n||""})),s.show(),a&&window.setTimeout(function(){s.fadeOut()},3e3)},infoMsg:function(e,t,n){this.showMessage(e,t,"info",n)},successMsg:function(e,t){this.showMessage(e,t,"success",!0)},warnMsg:function(e,t){this.showMessage(e,t,"warn")},errorMsg:function(e,t){this.showMessage(e,t,"error")},getLabList:function(t){var n=t.options,i=this,a=n.labListAction;return a?e.get(a,{strQuery:JSON.stringify({PDUGID:n.pdu}),strField:JSON.stringify({Name:1})},function(e){"0x0000"===e.ErrCode?t.labList=r.jsonMap(e.Documents):i.errorMsg(t,e.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)}):e.ajax().done(function(){t.labList=[]})},getCabList:function(t){var n=t.options,i=this;return i.infoMsg(t,i.getText(t,"loading")),e.get(n.cabListAction,{sParams:JSON.stringify({PDU:n.pdu,LabGID:n.lab})},function(n){"0x0000"===n.ErrCode?(i.successMsg(t,i.getText(t,"loadSuccess")),t.cabList=e.map(n.Jsons,function(e,t){var n=JSON.parse(e);return{CabinetNum:n.CabinetNum,CabinetType:n.CabinetType}})):i.errorMsg(t,n.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)})},getCabInfo:function(t,n,i){var a=t.options,o=a.lab,l=this,s=a.cabInfoAction,c="cab-dev"===i||"cab-iond"===i||"cab-server"===i;return s?e.get(s,{strCabParams:JSON.stringify({LabGID:o,CabinetNum:n}),strDevParams:JSON.stringify({PhysicLabId:o,CabinetNum:n}),IsSepecialCab:c},function(e){"0x0000"===e.ErrCode?t.cabInfo={deviceList:r.jsonMap(e.DeviceList.Documents),uNum:r.jsonMap(e.UNum.Documents)}:l.errorMsg(t,e.ErrCode)}).fail(function(e){l.errorMsg(t,e.statusText)}):e.ajax().done(function(e){t.cabInfo=a.fakeCabInfo})},getCabType:function(e){var t="";switch(e){case"cab-down":case"cab-down-low":case"cab-down-middle":case"cab-down-high":t="cab";break;case"cab-dev":t="devCab";break;case"cab-iond":t="iondCab";break;case"cab-server":t="serverCab";break;case"power-down":t="powerCab";break;case"toggle-down":t="toggleCab";break;case"net-down":t="netCab";break;case"line-down":t="lineCab"}return t},getCabUCount:function(t){var n=t.options,i=this,a=n.cabUCountAction;return a?e.get(a,{strParams:JSON.stringify({LabGID:n.lab})},function(e){"0x0000"===e.ErrCode?t.cabUCountList=r.jsonMap(e.Documents):i.errorMsg(t,e.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)}):e.ajax().done(function(){t.cabUCountList=n.fakeCabUCount})},updateLabAction:function(t,n){var i=t.options,a=this;return e.post(i.updateLabAction,{strParams:JSON.stringify({LabGID:i.lab,UsedCabinetNum:n})}).fail(function(e){a.errorMsg(t,e.statusText)})},updateSpecialCab:function(t,n){var i=t.options,a=this;return e.post(i.updateSpeCabAction,{strParams:JSON.stringify({LabGID:i.lab,CabinetNum:n})}).fail(function(e){a.errorMsg(t,e.statusText)})},modal:function(n,i){var a=e('<div class="'+o.modalMask+'" id="'+n.dom.id+'-lde-mask"></div>').appendTo(e(t.body)),l=e('<div class="'+o.modal+'"><div class="'+o.modalBody+'"></div></div>').appendTo(a),s=e('<div class="lde-designer-modal-close">×</div>').appendTo(l);i&&i.call(a),s.click(function(){a.remove()})},confirm:function(t,n,i){var a=this;this.modal(t,function(){var l=this,s=l.find("."+o.modalBody);s.append('<div class="lde-designer-modal-messager">'+n+"</div>"),s.append(r.tpl('<div class="lde-designer-modal-buttons"><button class="cancel" type="button">{cancel}</button><button class="ok" type="button">{ok}</button></div>',{ok:a.getText(t,"ok"),cancel:a.getText(t,"cancel")})),s.on("click","button",function(){l.remove(),e(this).hasClass("ok")&&i&&i.call(this)})})},exportImage:function(n){var i=n.graph,a=n.options,o=a.lab,l=a.exportAction;if(l){var s=new mxImageExport,r=i.view.scale;s.includeOverlays=!0;var c=mxUtils.createXmlDocument(),d=null!=c.createElementNS?c.createElementNS(mxConstants.NS_SVG,"svg"):c.createElement("svg");null==c.createElementNS?d.setAttribute("xmlns",mxConstants.NS_SVG):d.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",mxConstants.NS_XLINK),d.style.background=e(n.dom).css("background"),d.setAttribute("width",Math.ceil(1*a.width/r)+2+"px"),d.setAttribute("height",Math.ceil(1*a.height/r)+2+"px"),d.setAttribute("version","1.1");var p=null!=c.createElementNS?c.createElementNS(mxConstants.NS_SVG,"g"):c.createElement("g");p.setAttribute("transform","translate(0.5,0.5)"),d.appendChild(p);var u=new mxSvgCanvas2D(p),h=i.getBackgroundImage();u.image(0,0,h.width,h.height,h.src);var g=null!=c.createElementNS?c.createElementNS(mxConstants.NS_SVG,"g"):c.createElement("g");g.setAttribute("transform","translate(0.5,0.5)"),d.appendChild(g),c.appendChild(d);var b=new mxSvgCanvas2D(g);b.scale(1/r),s.drawState(i.getView().getState(i.model.root),b);var m=encodeURIComponent(mxUtils.getXml(d));new mxXmlRequest(l,"filename="+o+".svg&format=svg&xml="+m).simulate(t,"_blank")}},show:function(e){var t=e.graph,n=e.options,i=t.getGraphBounds(),a=window.open(),l=a.document;mxUtils.show(t,l,i.x,i.y,n.width,n.height);var s=l.body;return l.title=n.lab,s.className=c.name,s.children[0].className=o.printer,a},print:function(e){var t=this.show(e),n=function(){t.focus(),t.print(),t.close()};mxClient.IS_GC?t.setTimeout(n,500):n()},rotateCells:function(e){mxVertexHandler.prototype.rotationEnabled=!0,mxVertexHandler.prototype.rotateClick=function(){this.state.view.graph.turnShapes([this.state.cell])},mxGraph.prototype.turnShapes=function(e){var t=this.getModel(),n=[];t.beginUpdate();try{for(var i=0;i<e.length;i++){var a=e[i];if(t.isVertex(a)){var o=this.getCellGeometry(a);if(null!=o){(o=o.clone()).x+=o.width/2-o.height/2,o.y+=o.height/2-o.width/2;var l=o.width;o.width=o.height,o.height=l,t.setGeometry(a,o);var s=this.view.getState(a);if(null!=s){var r=s.style[mxConstants.STYLE_DIRECTION]||"east";"east"==r?r="south":"south"==r?r="west":"west"==r?r="north":"north"==r&&(r="east"),this.setCellStyles(mxConstants.STYLE_DIRECTION,r,[a])}n.push(a)}}}}finally{t.endUpdate()}return n};var t=e.options,n=mxVertexHandler.prototype.createSizerShape;mxVertexHandler.prototype.createSizerShape=function(i,a,o){var l=new mxImage(e.path.imgPath+t.rotateImage,t.rotateSize,t.rotateSize);return this.handleImage=a==mxEvent.ROTATION_HANDLE?l:this.handleImage,n.apply(this,arguments)}},overridePrototype:function(){mxGraph.prototype.init=function(e){this.container=e,this.cellEditor=this.createCellEditor(),this.view.init(),this.sizeDidChange(),mxClient.IS_IE&&(mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()})),mxEvent.addListener(e,"selectstart",mxUtils.bind(this,function(e){return this.isEditing()||!this.isMouseDown&&!mxEvent.isShiftDown(e)}))),8==t.documentMode&&e.insertAdjacentHTML("beforeend","<"+mxClient.VML_PREFIX+':group style="DISPLAY: none;"></'+mxClient.VML_PREFIX+":group>")},mxTooltipHandler.prototype.init=function(){null!=t.body&&(this.div=t.createElement("div"),this.div.className="mxTooltip",this.div.style.visibility="hidden",t.body.appendChild(this.div))},mxTooltipHandler.prototype.mouseMove=function(e,t){t.getX()==this.lastX&&t.getY()==this.lastY||(this.reset(t,!0),(this.isHideOnHover()||t.getState()!=this.state)&&this.hideTooltip()),this.lastX=t.getX(),this.lastY=t.getY()},mxTooltipHandler.prototype.show=function(e,t,n){if(!this.destroyed&&null!=e&&e.length>0){null==this.div&&this.init();var i=mxUtils.getScrollOrigin();this.div.style.zIndex=this.zIndex,this.div.style.left=t+i.x+"px",this.div.style.top=Math.min(n,580)+mxConstants.TOOLTIP_VERTICAL_OFFSET+i.y+"px",mxUtils.isNode(e)?(this.div.innerHTML="",this.div.appendChild(e)):this.div.innerHTML=e.replace(/\n/g,"<br>"),this.div.style.visibility="",mxUtils.fit(this.div)}}}},d=function(t,i){this.dom=t,this.options=e.extend(!0,{},n,i),this.init()};return d.prototype={constructor:d,init:function(){c.init(this)},zoomIn:function(){this.graph.zoomIn()},zoomOut:function(){this.graph.zoomOut()},actualSize:function(){this.graph.zoomActual()},remove:function(){this.graph.removeCells()},clear:function(){this.graph.getModel().clear()},goToEditor:function(){var e=this.options;window.open(r.tpl(e.editorUrl,e))},undo:function(){this.editor.undoManager.undo()},redo:function(){this.editor.undoManager.redo()},selectAll:function(){this.graph.selectAll()},copy:function(){mxClipboard.copy(this.graph)},paste:function(){return mxClipboard.paste(this.graph)},pasteHere:function(){c.pasteHere(this)},save:function(){c.save(this)},restore:function(){c.restore(this)},show:function(){c.show(this)},print:function(){c.print(this)},exportImage:function(){c.exportImage(this)}},e.fn.labDesigner=function(t,n){return"string"==typeof t?e.fn.labDesigner.methods[t](this[0],n):this.each(function(){var n=new d(this,t);return e.data(this,c.name,n),n})},e.fn.labDesigner.methods={instance:function(t){return e.data(t,c.name)},options:function(e){return this.instance(e).options},graph:function(e){return this.instance(e).graph}},e.fn.labDesigner.defaults=n,d});