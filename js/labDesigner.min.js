!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.labDesigner=t(e.jQuery)}(this,function(e){var t="undefined"!=typeof window?window.document:{},n={lab:null,width:1280,height:850,root:"static/plugins/labDesigner/",imageDir:"images/",dataDir:"data/",layout:"lab-layout.png",data:null,url:"lab.json",bakFile:"lab.bak.json",editorMode:!0,tooltip:null,contextMenu:null,handleImage:"dot.png",handleSize:16,rotateImage:"rotate.png",rotateSize:18,checkOverlayImage:"success.png",checkOverlaySize:16,rateOverlayImage:[{src:"low.png",hsrc:"low-h.png",min:0,max:30},{src:"middle.png",hsrc:"middle-h.png",min:30,max:60},{src:"high.png",hsrc:"high-h.png",min:60}],rateOverlaySize:6,moveStepSize:2,resizeStepSize:2,lang:"cn",editorUrl:"designer?lab={lab}",saveAction:"designer/save",labListAction:"",cabListAction:"designer/GetCabinetNumInfo",cabInfoAction:"",fakeCabInfo:{deviceList:[{SmallType:"OptiXOSN1800V",IP:"129.8.10.87",CabinetPosition:"A1-1",TotalRate:20},{SmallType:"OptiXOSN1800U",IP:"129.8.9.1",CabinetPosition:"A1-2",TotalRate:70}],uNum:[{no:"A1",usedU:11,allU:80}]},cabUCountAction:"",fakeCabUCount:[{no:"A1",usedU:11,allU:80},{no:"A2",usedU:19,allU:80},{no:"A3",usedU:22,allU:80},{no:"A4",usedU:28,allU:80},{no:"A5",usedU:18,allU:80},{no:"A6",usedU:31,allU:80},{no:"A7",usedU:26,allU:80},{no:"A8",usedU:46,allU:80},{no:"A9",usedU:34,allU:80},{no:"A10",usedU:69,allU:80},{no:"A11",usedU:58,allU:80},{no:"A12",usedU:45,allU:80},{no:"A13",usedU:39,allU:80},{no:"A14",usedU:71,allU:80}],updateLabAction:"designer/UpdateUsedCabinet",updateSpeCabAction:"designer/UpdateSpecialCabinetInfo",exportAction:"",pdu:"WuhanRC"},i="0x0000",a={browserNotSupported:{cn:"浏览器不支持！",en:"Browser is not supported!"},cab:{cn:"机柜",en:"Cabinet"},powerCab:{cn:"配电柜",en:"DB"},toggleCab:{cn:"开关柜",en:"SC"},netCab:{cn:"网络柜",en:"NC"},lineCab:{cn:"配线柜",en:"WC"},devCab:{cn:"仪表柜",en:"DEV"},iondCab:{cn:"IOND柜",en:"IOND"},serverCab:{cn:"服务器柜",en:"Server"},airCon:{cn:"空调",en:"AC"},wall:{cn:"承重墙",en:"Wall"},zoomIn:{cn:"放大",en:"ZoomIn"},zoomOut:{cn:"缩小",en:"ZoomOut"},actualSize:{cn:"实际大小",en:"Actual size"},fullsize:{cn:"全屏",en:"Fullsize"},move:{cn:"移动",en:"Move"},download:{cn:"下载",en:"Download"},capacity:{cn:"容量",en:"Capacity"},del:{cn:"删除",en:"Delete"},undo:{cn:"撤销",en:"Undo"},redo:{cn:"重做",en:"Redo"},save:{cn:"保存",en:"Save"},show:{cn:"显示",en:"Show"},hide:{cn:"隐藏",en:"Hide"},clear:{cn:"清空",en:"Clear"},copy:{cn:"复制",en:"Copy"},paste:{cn:"粘贴",en:"Paste"},edit:{cn:"编辑",en:"Edit"},selectAll:{cn:"全选",en:"Select All"},saveSuccess:{cn:"保存成功",en:"Save successful"},restore:{cn:"还原到上一个版本",en:"Revert to the previous version"},noChange:{cn:"没有改动",en:"No change"},labList:{cn:"实验室列表",en:"Lab list"},cabList:{cn:"机柜列表",en:"Cabinet list"},unsavedChanges:{cn:"存在未保存的改动，确定切换实验室？",en:"There are unsaved changes, be sure to change lab?"},ok:{cn:"确定",en:"OK"},cancel:{cn:"取消",en:"Cancel"},associated:{cn:"此机柜已关联",en:"The cabinet has been associated"},loading:{cn:"载入中...",en:"Loading..."},loadSuccess:{cn:"载入成功",en:"Load successfully"},print:{cn:"打印",en:"Print"}},o=[{name:"cab-down",image:"cab-down.png",type:"cab",width:24,lengend:!0},{name:"cab-down-low",image:"cab-down-low.png",type:"cab",width:24},{name:"cab-down-middle",image:"cab-down-middle.png",type:"cab",width:24},{name:"cab-down-high",image:"cab-down-high.png",type:"cab",width:24},{name:"cab-dev",image:"cab-dev.png",type:"devCab",width:24,lengend:!0},{name:"cab-iond",image:"cab-iond.png",type:"iondCab",width:24,lengend:!0},{name:"cab-server",image:"cab-server.png",type:"serverCab",width:24,lengend:!0},{name:"power-down",image:"power-down.png",type:"powerCab",width:24,lengend:!0},{name:"toggle-down",image:"toggle-down.png",type:"toggleCab",width:24,lengend:!0},{name:"net-down",image:"net-down.png",type:"netCab",width:24,lengend:!0},{name:"line-down",image:"line-down.png",type:"lineCab",width:24,lengend:!0},{name:"air-left",image:"air-left.png",type:"airCon",width:32,lengend:!0},{name:"air-mini",image:"air-mini.png",type:"airCon",width:32},{name:"wall",image:"wall.png",type:"wall",width:44}],s="lde-body",l="labDesigner",r="lde-toolbar",c="lde-designer",d="lde-lengend",u="lde-tooltip",p="lde-tools",h="lde-tip",g="lde-editor-toolbar",m="lde-editor-toolbox",f="lde-editor-propbox",v="separator",b="selected",C="lde-editor-box",y="lde-editor-toolbox-title",x="lde-editor-toolbox-item",w="lde-editor-messagebar",k="lde-editor-propbox-lab",S="lde-editor-propbox-lab-list",T="lde-editor-propbox-cab",U="lde-editor-propbox-cab-list",I="lde-editor-propbox-cab-title",M="lde-editor-propbox-cab-item",E="lde-designer-modal",L="lde-designer-modal-mask",N="lde-designer-modal-body",A="lde-printer",O='<div class="{cls}" data-name="{target}"><div class="title"><span>{name}</span><a href="javascript:void(0)">查看详情</a></div><div class="rate"><span>U位利用率：{rate}%</span><span class="u">U位：<div class="bar"><div class="success" style="width:{rate}%"></div></div>{use_u}/{total_u}</span></div><table class="devices"><thead><tr><th>设备({device_count})</th><th>IP</th><th>设备利用率</th><th>位置</th></tr></thead><tbody>{device_html}</tbody></table></div>',D='<tr><td><a class="name" href="javascript:void(0)">{SmallType}</a></td><td>{IP}</td><td>{Rate}</td><td>{CabinetPosition}</td></tr>',P='<li><div class="icon {type}"></div><div>{text}</div></li>',z='<li class="{type}" title="{text}"></li>',H='<li><span class="icon {cls}"></span><span>{text}</span></li>',_='<li class="icon {type}" title="{text}"></li>',G='<li class="{type}"></li>',V='<div class="toggle-icon {cls}" title="{text}"></div>',R='<li class="{selectedCls}" data-name="{text}"><div class="{cls}"><span class="text">{text}</span><span class="icon"></span></div></li>',F='<li><img src="{src}" alt="{name}" data-type="{name}" style="width:{width}px;" /></li>',j='<span class="shortcut">{key}</span>',X='<span class="icon {level}"></span><span class="text">{text}</span>',J='<div class="lde-editor-propbox-title">{title}</div>',B='<li data-val="{_id}" data-name="{name}" class="{cls}" title="{name}"><div class="icon"></div><div class="title">{name}</div><div class="checked-icon"></div></li>',Y={tools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"download",onclick:function(){this.exportImage()}},{type:"print",onclick:function(){this.print()}}],tip:[{cls:"low",text:"0-30"},{cls:"middle",text:"30-60"},{cls:"high",text:"60-100"}],etools:[{type:"zoomIn",onclick:function(){this.zoomIn()}},{type:"zoomOut",onclick:function(){this.zoomOut()}},{type:"actualSize",onclick:function(){this.actualSize()}},{type:"separator"},{type:"undo",onclick:function(){this.undo()},key:"Ctrl+Z"},{type:"redo",onclick:function(){this.redo()},key:"Ctrl+Y"},{type:"separator"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"},{type:"del",onclick:function(){this.remove()},key:"Delete"},{type:"clear",onclick:function(){this.clear()},key:"Ctrl+Delete"},{type:"separator"},{type:"restore",onclick:function(){this.restore()}},{type:"save",onclick:function(){this.save()},key:"Ctrl+S"}],emenus4cell:[{type:"copy",onclick:function(){this.copy()},key:"Ctrl+C"},{type:"del",onclick:function(){this.remove()},key:"Delete"}],emenus:[{type:"paste",onclick:function(){this.pasteHere()},key:"Ctrl+V"},{type:"selectAll",onclick:function(){this.selectAll()},key:"Ctrl+A"}],shortcuts:[{keyCode:46,key:"Delete",action:function(){this.remove()}},{keyCode:46,key:"Ctrl+Delete",isCtrl:!0,action:function(){this.clear()}},{keyCode:65,key:"Ctrl+A",isCtrl:!0,action:function(){this.selectAll()}},{keyCode:90,key:"Ctrl+Z",isCtrl:!0,action:function(){this.undo()}},{keyCode:89,key:"Ctrl+Y",isCtrl:!0,action:function(){this.redo()}},{keyCode:67,key:"Ctrl+C",isCtrl:!0,action:function(){this.copy()}},{keyCode:86,key:"Ctrl+V",isCtrl:!0,action:function(){this.paste()}},{keyCode:83,key:"Ctrl+S",isCtrl:!0,action:function(){this.save()}}]},K=function(t,n){if(!t||!n)return t;var i=/{(.*?)}/g,a=t.match(i);return e.each(a,function(e,a){var o=a.replace(i,"$1"),s=n[o];void 0!==s&&(t=t.replace(a,s))}),t},W=function(t){return e.map(t,function(e){return JSON.parse(e)})},q={name:"labDesigner",init:function(e){mxClient.isBrowserSupported()?(this.overridePrototype(),this.newGraph(e),this.setBackground(e),this.setContextMenu(e),this.setTooltip(e),this.setHighlight(e),this.putStyle(e),this.loadData(e)):mxUtils.error(this.getText(e,"browserNotSupported"),250,!1)},newGraph:function(n){var i=n.editor=new mxEditor,a=n.graph=i.graph,o=e(n.dom).empty(),r=e('<div class="'+c+'"></div>').appendTo(o);a.init(r[0]),e(t.body).addClass(s),o.addClass(l),a.labelsVisible=!1,a.cellsEditable=!1,a.cellsLocked=!0,this.initFilePath(n),this.initEditor(n)},initEditor:function(e){var t=e.graph;e.options.editorMode?(t.cellsLocked=!1,t.graphHandler.guidesEnabled=!0,new mxRubberband(t),this.setShortcuts(e),this.setEditorToolbar(e),this.setEditorToolbox(e),this.setEditorPropbox(e),this.setMessagebar(e),this.bindEvent(e),this.setHandleImage(e),this.rotateCells(e)):(this.setToolbar(e),this.setLengend(e))},setBackground:function(t,n){var i=t.options,a=t.graph,o=t.path.background,s=i.width,l=i.height;if(a.backgroundImage=new mxImage(o,s,l),a.view.validate(),!n){e(a.container).css({width:s,height:l});var r=new mxRectangle(0,0,s,l);a.maximumGraphBounds=r,a.minimumContainerSize=r}},bindEvent:function(e){var t=e.graph;t.getModel().addListener(mxEvent.CHANGE,mxUtils.bind(this,function(t,n){e.changed=!0})),t.addListener(mxEvent.CLICK,mxUtils.bind(this,function(t,n){var i=n.getProperty("cell");this.isCabCell(i)?this.initCabPropbox(e,i):this.initLabPropbox(e)}))},isCabCell:function(e,t){var n=e&&/^cab/i.test(e.style);return!0===t&&(n=n&&e.value),n},initFilePath:function(e){var t=e.options,n=K("{root}{dataDir}{lab}/",t);e.path={background:n+t.layout,file:n+t.url,bakFile:n+t.bakFile,imgPath:t.root+t.imageDir}},reloadEditor:function(e){this.initFilePath(e),this.setBackground(e,!0),e.clear(),this.loadData(e)},loadData:function(t,n){var i=this,a=t.options,o=a.url,s=function(e){e&&e.vertex?(t.data=e,i.fillGraph(t),n||(t.changed=!1),i.successMsg(t,i.getText(t,"loadSuccess"))):t.changed=!1};if(o)return o=t.path[n?"bakFile":"file"],i.infoMsg(t,i.getText(t,"loading")),void e.getJSON(o+"?ts="+(new Date).valueOf(),function(e){s(e)}).fail(function(e){t.changed=!1,i.errorMsg(t,e.statusText)});s(a.data)},putStyle:function(t){var n=t.options;e.each(o,function(e,n){t.graph.getStylesheet().putCellStyle(n.name,{shape:"image",image:t.path.imgPath+n.image})})},fillGraph:function(t,n,i){var a=t.graph,o=a.getModel(),s=a.getDefaultParent(),l=n||t.data.vertex,r=this;o.beginUpdate();try{e.each(l,function(e,n){var o=a.insertVertex(s,null,n.value,n.x,n.y,n.width,n.height,n.style);i&&a.setSelectionCell(o),t.options.editorMode&&n.value&&n.value.name&&r.setCheckCellOverlay(t,o)})}finally{o.endUpdate(),t.options.editorMode||r.getLabList(t).done(function(){r.getCabUCount(t).done(function(){r.setRateCellOverlay(t)})})}},save:function(t){if(t.changed){var n=t.graph.getChildVertices(),i=e.map(n,function(e,t){var n=e.geometry;return{width:n.width,height:n.height,x:n.x,y:n.y,style:e.style,value:e.value}}),a=this.getUsedCells(t,n).length,o=this.getSpecialCab(t,n),s=this;e.post(t.options.saveAction,{file:t.path.file,bakFile:t.path.bakFile,data:JSON.stringify({vertex:i})},function(e){"0x0000"===e.ErrCode?(s.successMsg(t,s.getText(t,"saveSuccess")),t.changed=!1,s.updateLabAction(t,a),o.length>0&&s.updateSpecialCab(t,o)):s.errorMsg(t,e.ErrCode)}).fail(function(e){s.errorMsg(t,e.statusText)})}else this.infoMsg(t,this.getText(t,"noChange"),!0)},getUsedCells:function(t,n){return e.grep(n||t.graph.getChildVertices(),function(e){return e.value&&e.value.name})},getSpecialCab:function(t,n){return e.map(n||t.graph.getChildVertices(),function(e){return("cab-dev"==e.style||"cab-iond"==e.style||"cab-server"==e.style)&&e.value&&e.value.name?e.value.name:null})},restore:function(e){e.clear(),this.loadData(e,!0)},setEditorToolbar:function(t){var n=e('<ul class="'+g+'"></ul>').prependTo(e(t.dom)),i=this;e.each(Y.etools,function(a,o){var s=o.type,l=s===v?G:_,r=o.key||"",c=r&&" ("+r+")",d=e(K(l,{type:s,text:i.getText(t,s)+c})),u=o.onclick;n.append(d),"function"==typeof u&&d.click(function(){u.call(t)})})},setEditorToolbox:function(t){var n=e('<div class="'+m+'"></div>').appendTo(e(t.dom)),i=e('<ul class="'+C+'"></ul>').appendTo(n),a=this,s=t.options;this.setToggleIcon(t,i,"left-hide","right-show");var l={};e.each(o,function(e,t){var n=t.type,i=l[n]||[];i.push(t),l[n]=i});var r=o[0].type;e.each(l,function(n,o){var s=e(K(R,{text:a.getText(t,n),cls:y,selectedCls:n===r?b:""})).appendTo(i),l=e('<ul class="'+x+'"></ul>').appendTo(s);e.each(o,function(n,i){i.src=t.path.imgPath+i.image;var o=e(K(F,i)).appendTo(l);a.makeDraggable(o.find("img")[0],t)})}),i.on("click","."+y,function(){e(this).parent().toggleClass(b)})},setToggleIcon:function(t,n,i,a){var o=this,s;e(K(V,{cls:i,text:o.getText(t,"hide")})).insertAfter(n).click(function(){n.toggle(),e(this).toggleClass(a).attr("title",o.getText(t,n.is(":visible")?"hide":"show"))})},makeDraggable:function(e,t){mxClient.IS_IE&&mxEvent.addListener(e,"dragstart",function(e){e.returnValue=!1});var n=t.graph,i=e.cloneNode(!0),a=this,o;mxUtils.makeDraggable(e,n,function(n,i,o,s,l){a.fillGraph(t,[{x:s,y:l,width:e.width,height:e.height,style:e.getAttribute("data-type")}],!0)},i,null,null,n.autoscroll,!0).isGuidesEnabled=function(){return n.graphHandler.guidesEnabled}},setContextMenu:function(t){var n=t.options,i=n.contextMenu,a=this,o=t.graph;mxEvent.disableContextMenu(o.container),o.popupMenuHandler.factoryMethod="function"==typeof i?function(e,n,a){return i.apply(t,arguments)}:function(i,s,l){if(n.editorMode){var r,c=0===o.getSelectionCells().length?Y.emenus:Y.emenus4cell;e.each(c,function(n,o){var s=o.type,l=o.onclick,r=i.addItem(a.getText(t,s),null,function(){l&&l.call(t)},null,"icon "+s);o.key&&e(r).find(":last").append(K(j,o))})}}},pasteHere:function(e){var t=e.graph;t.getModel().beginUpdate();try{var n=e.paste(),i=n&&t.getBoundingBoxFromGeometry(n);if(null===i)return;var a=t.view.translate,o=t.view.scale,s=a.x,l=a.y,r=Math.round(t.snap(t.popupMenuHandler.triggerX/o-s)),c=Math.round(t.snap(t.popupMenuHandler.triggerY/o-l));t.cellsMoved(n,r-i.x,c-i.y)}finally{t.getModel().endUpdate()}},setShortcuts:function(t){var n=t.graph,i=new mxKeyHandler(n);e.each(Y.shortcuts,function(e,n){i[n.isCtrl?"bindControlKey":"bindKey"](n.keyCode,function(e){n.action.call(t)})}),t.keyHandler=i,this.setArrowEvent(t)},setArrowEvent:function(t){var n=t.graph,i=t.keyHandler,a=t.options,o=a.moveStepSize,s=a.resizeStepSize,l={LEFT:37,UP:38,RIGHT:39,DOWN:40},r=[],c=null,d=function(e,t,i){r.push(function(){if(i){n.getModel().beginUpdate();try{for(var a=n.getSelectionCells(),o=0;o<a.length;o++)if(n.getModel().isVertex(a[o])&&n.isCellResizable(a[o])){var s=n.getCellGeometry(a[o]);null!=s&&(s=s.clone(),e==l.LEFT?s.width=Math.max(0,s.width-t):e==l.UP?s.height=Math.max(0,s.height-t):e==l.RIGHT?s.width+=t:e==l.DOWN&&(s.height+=t),n.getModel().setGeometry(a[o],s))}}finally{n.getModel().endUpdate()}}else{var r=0,c=0;e==l.LEFT?r=-t:e==l.UP?c=-t:e==l.RIGHT?r=t:e==l.DOWN&&(c=t),n.moveCells(n.getMovableCells(n.getSelectionCells()),r,c)}}),null!=c&&window.clearTimeout(c),c=window.setTimeout(function(){if(r.length>0){n.getModel().beginUpdate();try{for(var e=0;e<r.length;e++)r[e]();r=[]}finally{n.getModel().endUpdate()}n.scrollCellToVisible(n.getSelectionCell())}},200)};e.each(l,function(e,t){i.bindKey(t,function(e){d(e.keyCode,o)}),i.bindControlKey(t,function(e){d(e.keyCode,s,!0)})})},setTooltip:function(t){var n=t.graph,i,a=t.options.tooltip,o=this;n.getTooltipForCell="function"==typeof a?function(e){return a.apply(t,arguments)}:function(i){if(o.isCabCell(i,!0)){var a=i.value,s=t.dom.id+"-"+a.name,l={cls:u,name:a.name,device_count:0,total_u:0,use_u:0,rate:0,device_html:"",target:s};return o.getCabInfo(t,a.name,i.style).done(function(i){var a=t.cabInfo,r=a.deviceList,c=a.uNum[0]||{allU:0,usedU:0},d="";e.each(r,function(e,t){t.Rate="-1"===t.TotalRate?"-":(t.TotalRate||0)+"%",d+=K(D,t)}),e.extend(l,{device_count:r.length,total_u:c.allU,use_u:c.usedU,rate:c.allU>0?parseFloat((c.usedU/c.allU*100).toFixed(1)):0,device_html:d});var p=K(O,l);e("."+u).filter('[data-name="'+s+'"]').parent().html(p),o.fitTooltip(n)}),K(O,l)}}},setHandleImage:function(e){var t=e.options;mxVertexHandler.prototype.handleImage=new mxImage(e.path.imgPath+t.handleImage,t.handleSize,t.handleSize)},fitTooltip:function(e){var t=e.tooltipHandler&&e.tooltipHandler.div;t&&mxUtils.fit(t)},setHighlight:function(e){var t;new mxCellTracker(e.graph).highlight.strokeWidth=1},setLengend:function(t){var n=e('<ul class="'+d+'"></ul>').appendTo(e(t.dom)),i=this;e.each(o,function(e,a){a.lengend&&n.append(K(P,{type:a.type,text:i.getText(t,a.type)}))})},setToolbar:function(t){var n=e('<div class="'+r+'"></div>').prependTo(e(t.dom)),i=e('<ul class="'+p+'"></ul>').appendTo(n),a=e(K('<ul class="{cls}"><li>{text}(%)</li></ul>',{cls:h,text:this.getText(t,"capacity")})).appendTo(n),o=this;e.each(Y.tools,function(n,a){var s=e(K(z,{type:a.type,text:o.getText(t,a.type)})),l=a.onclick;i.append(s),"function"==typeof l&&s.click(function(){l.call(t)})}),e.each(Y.tip,function(e,t){a.append(K(H,t))})},setEditorPropbox:function(t){var n=e('<div class="'+f+'"></div>').appendTo(e(t.dom)),i=e('<div class="'+C+'"></div>').appendTo(n);this.setToggleIcon(t,i,"right-hide","left-show"),i.append('<div class="'+k+'"></div><div class="'+T+'"></div>'),this.initLabPropbox(t)},initLabPropbox:function(t){var n,i=e(t.dom).find("."+k);if(i.hasClass("loaded"))i.show().next().hide();else{e(K(J,{title:this.getText(t,"labList")})).appendTo(i);var a=e('<div class="lde-editor-propbox-body"></div>').appendTo(i),o=e('<ul class="'+S+'"></ul>').appendTo(a),s=t.options,l="selected",r=this,c=function(e){e.addClass("selected").siblings().removeClass("selected"),s.lab=e.attr("data-val"),r.reloadEditor(t),r.resetCabPropbox(t)};this.getLabList(t).done(function(){i.addClass("loaded"),e.each(t.labList,function(e,t){o.append(K(B,{_id:t._id,name:t.Name,cls:t._id===s.lab?"selected":""}))}),o.on("click","li",function(){var n=e(this);n.hasClass("selected")||(t.changed?r.confirm(t,r.getText(t,"unsavedChanges"),function(){c(n)}):c(n))})})}},initCabPropbox:function(t,n){var i,a=e(t.dom).find("."+T),o=function(){a.show().prev().hide()},s=b,l=n.value&&n.value.name,r=this.getGroupName(l),c=this.getCabType(n.style);if(a.hasClass("loaded"))return o(),this.loadCabList(t,n,c,r,s),a.find("."+U+">li").removeClass(s).filter('[data-name="'+r+'"]').find("."+I).trigger("click"),void a.find("."+M+">li").removeClass(s).filter('[data-name="'+l+'"]').addClass(s);a.empty(),o(),e(K(J,{title:this.getText(t,"cabList")})).appendTo(a);var d=e('<div class="lde-editor-propbox-body"></div>').appendTo(a),u=e('<ul class="'+U+'"></ul>').appendTo(d),p=t.options,h=this;this.getCabList(t).done(function(){a.addClass("loaded"),h.loadCabList(t,n,c,r,s)})},loadCabList:function(t,n,i,a,o){var s=this;e("."+T+" .lde-editor-propbox-body").empty();var l,r=e(t.dom).find("."+T),c=e('<div class="lde-editor-propbox-body"></div>').appendTo(r),d=n.value&&n.value.name,u=e('<ul class="'+U+'"></ul>').appendTo(c);if(s.groupCabs(t,i),e.isEmptyObject(t.groupCabs)){var p='<li style="padding:5px;color:#fff;">暂无该类型可绑定的机柜！</li>';e(".lde-editor-propbox-cab-list").append(p)}else e.each(t.groupCabs,function(t,n){var i=e(K(R,{text:t,cls:I,selectedCls:a===t?o:""})).appendTo(u),s=e('<ul class="'+M+'"></ul>').appendTo(i);e.each(n,function(e,t){s.append(K(B,{_id:t._id||"",name:t.CabinetNum,cls:t.CabinetNum===d?o:""}))})});u.on("click","."+I,function(){e(this).parent().toggleClass(o).siblings().removeClass(o)}),u.on("click","."+M+">li",function(){var n=t.graph.getSelectionCell(),i=e(this);i.hasClass(o)||(i.addClass(o).siblings().removeClass(o),n.value={name:i.attr("data-name")},s.setCheckCellOverlay(t,n),t.changed=!0)})},groupCabs:function(t,n){var i=t.cabList,a={},o=this,s=e.map(i,function(e,t){return e.CabinetType&&e.CabinetType==n?e:null});t.groupCabs=a,s.length>0&&(e.each(s,function(e,t){var n=o.getGroupName(t.CabinetNum);a[n]?a[n].push(t):a[n]=[t]}),e.each(a,function(e,t){t=t.sort(function(e,t){return parseInt(e.CabinetNum.slice(1))-parseInt(t.CabinetNum.slice(1))})}),t.groupCabs=a)},getGroupName:function(e){return e&&e.slice(0,1).toUpperCase()},resetCabPropbox:function(t){e(t.dom).find("."+T).removeClass("loaded")},setCheckCellOverlay:function(e,t){var n=e.graph,i=e.options,a=i.checkOverlaySize,o=new mxImage(e.path.imgPath+i.checkOverlayImage,a,a),s=new mxCellOverlay(o,null,"center","middle",null,"default");n.addCellOverlay(t,s),s.addListener(mxEvent.CLICK,mxUtils.bind(this,function(t,i){var a=i.getProperty("cell");n.setSelectionCell(a),this.initCabPropbox(e,a)}))},setRateCellOverlay:function(t,n,i){var a=t.graph,s=t.path.imgPath,l=t.options,r=l.rateOverlaySize,c=l.rateOverlayImage,d=o[0].width,u=function(t,n){var i=0===n?c[0]:e.grep(c,function(e){return n>e.min&&n<=(e.max||Number.MAX_VALUE)})[0];if(i){var o=mxUtils.getValue(a.view.getState(t).style,mxConstants.STYLE_DIRECTION,"east"),l,u,p,h,g,m,f,v=8,b=t.geometry.width,C=t.geometry.height,y;"east"===o||"west"===o?(g="src",m=(p=r*(y=b/d))/2,f=(h=C-8*y)/2,"west"===o&&(f+=8*y)):(g="hsrc",m=(p=b-8*(y=C/d))/2,f=(h=r*y)/2,"south"===o&&(m+=8*y)),l=new mxImage(s+i[g],p,h),u=new mxCellOverlay(l,null,"left","top",new mxPoint(m,f),"default"),a.addCellOverlay(t,u)}};if(n&&i)u(n,i);else{var p=this.getUsedCells(t),h=t.cabUCountList||[];e.each(p,function(t,n){var i=e.grep(h,function(e){return e.no===n.value.name})[0];if(i){var a=i.allU>0?i.usedU/i.allU*100:0;u(n,a)}})}},getText:function(e,t){var i=a[t],o=e.options.lang;return i&&(i[o]||i[n.lang])},setMessagebar:function(t){var n=e(t.dom).find("."+g);e(K('<li class="{cls}"></li>',{cls:w})).appendTo(n)},showMessage:function(t,n,i,a){var o=e(t.dom).find("."+w);o.html(K(X,{level:i||"",text:n||""})),o.show(),a&&window.setTimeout(function(){o.fadeOut()},3e3)},infoMsg:function(e,t,n){this.showMessage(e,t,"info",n)},successMsg:function(e,t){this.showMessage(e,t,"success",!0)},warnMsg:function(e,t){this.showMessage(e,t,"warn")},errorMsg:function(e,t){this.showMessage(e,t,"error")},getLabList:function(t){var n=t.options,i=this,a=n.labListAction;return a?e.get(a,{strQuery:JSON.stringify({PDUGID:n.pdu}),strField:JSON.stringify({Name:1})},function(e){"0x0000"===e.ErrCode?t.labList=W(e.Documents):i.errorMsg(t,e.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)}):e.ajax().done(function(){t.labList=[]})},getCabList:function(t){var n=t.options,i=this;return i.infoMsg(t,i.getText(t,"loading")),e.get(n.cabListAction,{sParams:JSON.stringify({PDU:n.pdu,LabGID:n.lab})},function(n){"0x0000"===n.ErrCode?(i.successMsg(t,i.getText(t,"loadSuccess")),t.cabList=e.map(n.Jsons,function(e,t){var n=JSON.parse(e);return{CabinetNum:n.CabinetNum,CabinetType:n.CabinetType}})):i.errorMsg(t,n.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)})},getCabInfo:function(t,n,i){var a=t.options,o=a.lab,s=this,l=a.cabInfoAction,r="cab-dev"===i||"cab-iond"===i||"cab-server"===i;return l?e.get(l,{strCabParams:JSON.stringify({LabGID:o,CabinetNum:n}),strDevParams:JSON.stringify({PhysicLabId:o,CabinetNum:n}),IsSepecialCab:r},function(e){"0x0000"===e.ErrCode?t.cabInfo={deviceList:W(e.DeviceList.Documents),uNum:W(e.UNum.Documents)}:s.errorMsg(t,e.ErrCode)}).fail(function(e){s.errorMsg(t,e.statusText)}):e.ajax().done(function(i){var o=a.fakeCabInfo;o.uNum=e.grep(a.fakeCabUCount,function(e){return e.no===n}),t.cabInfo=o})},getCabType:function(e){var t="";switch(e){case"cab-down":case"cab-down-low":case"cab-down-middle":case"cab-down-high":t="cab";break;case"cab-dev":t="devCab";break;case"cab-iond":t="iondCab";break;case"cab-server":t="serverCab";break;case"power-down":t="powerCab";break;case"toggle-down":t="toggleCab";break;case"net-down":t="netCab";break;case"line-down":t="lineCab"}return t},getCabUCount:function(t){var n=t.options,i=this,a=n.cabUCountAction;return a?e.get(a,{strParams:JSON.stringify({LabGID:n.lab})},function(e){"0x0000"===e.ErrCode?t.cabUCountList=W(e.Documents):i.errorMsg(t,e.ErrCode)}).fail(function(e){i.errorMsg(t,e.statusText)}):e.ajax().done(function(){t.cabUCountList=n.fakeCabUCount})},updateLabAction:function(t,n){var i=t.options,a=this;return e.post(i.updateLabAction,{strParams:JSON.stringify({LabGID:i.lab,UsedCabinetNum:n})}).fail(function(e){a.errorMsg(t,e.statusText)})},updateSpecialCab:function(t,n){var i=t.options,a=this;return e.post(i.updateSpeCabAction,{strParams:JSON.stringify({LabGID:i.lab,CabinetNum:n})}).fail(function(e){a.errorMsg(t,e.statusText)})},modal:function(n,i){var a=e('<div class="'+L+'" id="'+n.dom.id+'-lde-mask"></div>').appendTo(e(t.body)),o=e('<div class="'+E+'"><div class="'+N+'"></div></div>').appendTo(a),s=e('<div class="lde-designer-modal-close">×</div>').appendTo(o);i&&i.call(a),s.click(function(){a.remove()})},confirm:function(t,n,i){var a=this;this.modal(t,function(){var o=this,s=o.find("."+N);s.append('<div class="lde-designer-modal-messager">'+n+"</div>"),s.append(K('<div class="lde-designer-modal-buttons"><button class="cancel" type="button">{cancel}</button><button class="ok" type="button">{ok}</button></div>',{ok:a.getText(t,"ok"),cancel:a.getText(t,"cancel")})),s.on("click","button",function(){o.remove(),e(this).hasClass("ok")&&i&&i.call(this)})})},exportImage:function(n){var i=n.graph,a=n.options,o=a.lab,s=a.exportAction;if(s){var l=1,r=1,c=new mxImageExport,d=i.view.scale;c.includeOverlays=!0;var u=mxUtils.createXmlDocument(),p=null!=u.createElementNS?u.createElementNS(mxConstants.NS_SVG,"svg"):u.createElement("svg");null==u.createElementNS?p.setAttribute("xmlns",mxConstants.NS_SVG):p.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink",mxConstants.NS_XLINK),p.style.background=e(n.dom).css("background"),p.setAttribute("width",Math.ceil(1*a.width/d)+2+"px"),p.setAttribute("height",Math.ceil(1*a.height/d)+2+"px"),p.setAttribute("version","1.1");var h=null!=u.createElementNS?u.createElementNS(mxConstants.NS_SVG,"g"):u.createElement("g");h.setAttribute("transform","translate(0.5,0.5)"),p.appendChild(h);var g=new mxSvgCanvas2D(h),m=i.getBackgroundImage();g.image(0,0,m.width,m.height,m.src);var f=null!=u.createElementNS?u.createElementNS(mxConstants.NS_SVG,"g"):u.createElement("g");f.setAttribute("transform","translate(0.5,0.5)"),p.appendChild(f),u.appendChild(p);var v=new mxSvgCanvas2D(f);v.scale(1/d),c.drawState(i.getView().getState(i.model.root),v);var b=encodeURIComponent(mxUtils.getXml(p));new mxXmlRequest(s,"filename="+o+".svg&format=svg&xml="+b).simulate(t,"_blank")}},show:function(e){var t=e.graph,n=e.options,i=t.getGraphBounds(),a=window.open(),o=a.document;mxUtils.show(t,o,i.x,i.y,n.width,n.height);var s=o.body;return o.title=n.lab,s.className=q.name,s.children[0].className=A,a},print:function(e){var t=this.show(e),n=function(){t.focus(),t.print(),t.close()};mxClient.IS_GC?t.setTimeout(n,500):n()},rotateCells:function(e){mxVertexHandler.prototype.rotationEnabled=!0,mxVertexHandler.prototype.rotateClick=function(){this.state.view.graph.turnShapes([this.state.cell])},mxGraph.prototype.turnShapes=function(e){var t=this.getModel(),n=[];t.beginUpdate();try{for(var i=0;i<e.length;i++){var a=e[i];if(t.isVertex(a)){var o=this.getCellGeometry(a);if(null!=o){(o=o.clone()).x+=o.width/2-o.height/2,o.y+=o.height/2-o.width/2;var s=o.width;o.width=o.height,o.height=s,t.setGeometry(a,o);var l=this.view.getState(a);if(null!=l){var r=l.style[mxConstants.STYLE_DIRECTION]||"east";"east"==r?r="south":"south"==r?r="west":"west"==r?r="north":"north"==r&&(r="east"),this.setCellStyles(mxConstants.STYLE_DIRECTION,r,[a])}n.push(a)}}}}finally{t.endUpdate()}return n};var t=e.options,n=mxVertexHandler.prototype.createSizerShape;mxVertexHandler.prototype.createSizerShape=function(i,a,o){var s=new mxImage(e.path.imgPath+t.rotateImage,t.rotateSize,t.rotateSize);return this.handleImage=a==mxEvent.ROTATION_HANDLE?s:this.handleImage,n.apply(this,arguments)}},overridePrototype:function(){mxGraph.prototype.init=function(e){this.container=e,this.cellEditor=this.createCellEditor(),this.view.init(),this.sizeDidChange(),mxClient.IS_IE&&(mxEvent.addListener(window,"unload",mxUtils.bind(this,function(){this.destroy()})),mxEvent.addListener(e,"selectstart",mxUtils.bind(this,function(e){return this.isEditing()||!this.isMouseDown&&!mxEvent.isShiftDown(e)}))),8==t.documentMode&&e.insertAdjacentHTML("beforeend","<"+mxClient.VML_PREFIX+':group style="DISPLAY: none;"></'+mxClient.VML_PREFIX+":group>")},mxTooltipHandler.prototype.init=function(){null!=t.body&&(this.div=t.createElement("div"),this.div.className="mxTooltip",this.div.style.visibility="hidden",t.body.appendChild(this.div))},mxTooltipHandler.prototype.mouseMove=function(e,t){t.getX()==this.lastX&&t.getY()==this.lastY||(this.reset(t,!0),(this.isHideOnHover()||t.getState()!=this.state)&&this.hideTooltip()),this.lastX=t.getX(),this.lastY=t.getY()},mxTooltipHandler.prototype.show=function(e,t,n){if(!this.destroyed&&null!=e&&e.length>0){null==this.div&&this.init();var i=mxUtils.getScrollOrigin();this.div.style.zIndex=this.zIndex,this.div.style.left=t+i.x+"px",this.div.style.top=Math.min(n,580)+mxConstants.TOOLTIP_VERTICAL_OFFSET+i.y+"px",mxUtils.isNode(e)?(this.div.innerHTML="",this.div.appendChild(e)):this.div.innerHTML=e.replace(/\n/g,"<br>"),this.div.style.visibility="",mxUtils.fit(this.div)}}}},Z=function(t,i){this.dom=t,this.options=e.extend(!0,{},n,i),this.init()};return Z.prototype={constructor:Z,init:function(){q.init(this)},zoomIn:function(){this.graph.zoomIn()},zoomOut:function(){this.graph.zoomOut()},actualSize:function(){this.graph.zoomActual()},remove:function(){this.graph.removeCells()},clear:function(){this.graph.getModel().clear()},goToEditor:function(){var e=this.options;window.open(K(e.editorUrl,e))},undo:function(){this.editor.undoManager.undo()},redo:function(){this.editor.undoManager.redo()},selectAll:function(){this.graph.selectAll()},copy:function(){mxClipboard.copy(this.graph)},paste:function(){return mxClipboard.paste(this.graph)},pasteHere:function(){q.pasteHere(this)},save:function(){q.save(this)},restore:function(){q.restore(this)},show:function(){q.show(this)},print:function(){q.print(this)},exportImage:function(){q.exportImage(this)}},e.fn.labDesigner=function(t,n){return"string"==typeof t?e.fn.labDesigner.methods[t](this[0],n):this.each(function(){var n=new Z(this,t);return e.data(this,q.name,n),n})},e.fn.labDesigner.methods={instance:function(t){return e.data(t,q.name)},options:function(e){return this.instance(e).options},graph:function(e){return this.instance(e).graph}},e.fn.labDesigner.defaults=n,Z});